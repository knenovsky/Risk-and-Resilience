---
title: "06_figures_charts"
author: "Kolja Nenoff"
date: "2023-07-08"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
library(rstudioapi)
library(magrittr)
library(tidyverse)
library(data.table)
library(parallel)
library(dimRed)
library(devtools)
library(igraph)
library(energy)
library(ggrepel)
library(ggalt)
library(ggraph)
library(trend)
library(riverplot)
library(RANN)
library(RJSONIO)
library(RSpectra)
library(pcaMethods)
require(broom)
require(GGally)
require(ggpubr)
require(xgboost)
require(caret)
require(pdp)
require(iml)
require(data.table)
require(tidyverse)
```
```{r}
## set up path
DATA_DIR <- "../data/"
FIGURE_DIR <- "../figures/01_figures/"
WDI_DIR <- paste0(DATA_DIR, "WDI_data_230609/WDI_CSV")
RELATIVE_INDICATORS_FILE_NAME <- "01_data/relative_indicators_2023_06.R" # nolint
source("../libraries/01a_lib_social_indicators.R")

```
# data
```{r,Excess Mortility WHO Set}
excessCounrty_year<-read_excel("../data/230224_nature_WHO_excess_death/2022-03-25_covid-19_gem/WHO_COVID_Excess_Deaths_EstimatesByCountry.xlsx",sheet = 2)
excessCounrty_covariates<-read_excel("../data/230224_nature_WHO_excess_death/2022-03-25_covid-19_gem/WHO_COVID_Excess_Deaths_EstimatesByCountry.xlsx",sheet = 3)
excessRegion_year<-read_excel("../data/230224_nature_WHO_excess_death/2022-03-25_covid-19_gem/WHO_COVID_Excess_Deaths_EstimatesByRegion.xlsx",sheet = 2)
excessRegion_income<-read_excel("../data/230224_nature_WHO_excess_death/2022-03-25_covid-19_gem/WHO_COVID_Excess_Deaths_EstimatesByIncome.xlsx",sheet = 2)
excessRegion_income %>% group_by(income) %>% 
  summarise(p_value_mort=sum(excess.mean)/sum(expected.mean)*100,excess_comul=sum(excess.mean))
excessCounrty_year_pvalue<-excessCounrty_year %>% group_by(country,iso3,year) %>% 
  summarise(p_value_mort=sum(excess.mean)/sum(expected.mean)*100,excess_comul=sum(excess.mean))
excessCounrty_year %>% filter(year==2020)-> excessCounrty_year_2020
p_value_global_2020=sum(excessCounrty_year_2020$excess.mean,na.rm = T)/sum(excessCounrty_year_2020$expected.mean,na.rm = T)*100
excessCounrty_year %>% filter(year==2021)-> excessCounrty_year_2020
p_value_global_2021=sum(excessCounrty_year_2020$excess.mean,na.rm = T)/sum(excessCounrty_year_2020$expected.mean,na.rm = T)*100
excessCounrty_monthly_pvalue<-excessCounrty_year  %>% 
  mutate(p_value_mort=(excess.mean)/(expected.mean)*100)
```



#  Methods 
## a Compare ISO and PCA
```{r}

residual_sample_variances <- readRDS("../data/residual_sample_variances.RDS")
 
cons_iso_pca<-readRDS("../data/cons_iso_pca.RDS")
occurrence_table       <- cons_iso_pca$occurrence_table
wdi_data_cons          <- cons_iso_pca$wdi_data_cons
wdi_data_cons_pca      <- cons_iso_pca$wdi_data_cons_pca
wdi_data_cons_iso      <- cons_iso_pca$wdi_data_cons_iso
wdi_data_qual_cons_pca <- cons_iso_pca$wdi_data_qual_cons_pca
wdi_data_qual_cons_iso <- cons_iso_pca$wdi_data_qual_cons_iso
knns                   <- cons_iso_pca$knns


pca_res <- residual_sample_variances$pca
iso_res <- residual_sample_variances$iso
median_res_var_pca <- residual_sample_variances$median_pca
median_res_var_iso <- residual_sample_variances$median_iso
hdi_res_var <- residual_sample_variances$hdi
```
```{r}
data.frame(Dimensions = seq(1:length(pca_res[[1]])),pca=pca_res[[1]],iso=iso_res[[1]])
iso_res
```
## b Visualisation of  Nonlinearity

# Results
##  a Linear Estimation of Exmort
```{r}

dimred2021_knn250_2<-fread("../output/02_230612_Dimred_ExcessMort_annual.csv")
subset2020<-dimred2021_knn250_2 %>% filter(year%in% 2019) %>% select(year,iso1,iso2,iso3,iso4,iso5,iso6,iso7,iso8,iso9,iso10,year,P_mort_2020) %>% 
  rename(ExcessMort=P_mort_2020) %>% mutate(P_mort_2020=NULL)
subset2021<-dimred2021_knn250_2 %>% filter(year%in% 2020) %>% select(year,iso1,iso2,iso3,iso4,iso5,iso6,iso7,iso8,iso9,iso10,year,P_mort_2021) %>% 
  rename(ExcessMort=P_mort_2021) %>% mutate(P_mort_2020=NULL)
bothyears<-rbind(subset2020,subset2021)
e<-lm(scale(ExcessMort)~iso1+iso2+iso3+iso4+iso5+iso6+iso7,bothyears[]) 
e %>%  summary

# for each year
e1<-lm(ExcessMort~iso1+iso2+iso3+iso4+iso5+iso6+iso7+iso8+iso9+iso10,bothyears[] %>% filter(year%in% 2019))
e2<-lm(ExcessMort~iso1+iso2+iso3+iso4+iso5+iso6+iso7+iso8+iso9+iso10,bothyears[] %>% filter(year%in% 2020))
e1_rsquared<-round(summary(e1)$r.squared,digits = 3)*100
e2_rsquared<-round(summary(e2)$r.squared,digits = 3)*100
# 
 e_plot2020<-ggcoef_model(e1)+ ggtitle(paste0("Isomap 2020; R\u00b2: ",e1_rsquared," %"))%>% suppressWarnings()
 e_plot2021<-ggcoef_model(e2)+ ggtitle(paste0("Isomap 2021; R\u00b2: ",e2_rsquared," %")) %>%  suppressWarnings()
plotBoth<-ggarrange(e_plot2020,e_plot2021,common.legend = T,legend = "bottom") %>% suppressWarnings() 
#ggsave("../figures/06_figures_Beta_plot.png",device = "png")
# annotate_figure(plotBoth, top = text_grob("Estimated betas for Isomap 2020 and 2021", 
#                color = "Slategray3", face = "bold", size = 12),bottom = text_grob("asd"))

f<-lm(pscore_mean~iso1+iso2+iso3+iso4+iso5+iso6+iso7+iso8+iso9+iso10,dimred2021_knn250_2[] %>% filter(year%in% 2019))
f_rsquared<-round(summary(f)$r.squared,digits = 3)*100
f_plot_pscoremean<-ggcoef_model(f)+ ggtitle(paste0("P Score ~ ; R\u00b2: ",f_rsquared," %"))%>% suppressWarnings()
f %>%  summary
#%>% ggsave(file= "../figures/06_beta_plot_2019_pscore.png",device = "png",width = 5,height = 7)
```
##  a 2  Non Linear Estimation of Exmort

```{r}
thisData<-dimred2021_knn250_2[] %>% filter(year%in% 2019)
IsoYear<-"2019"
Label<-"pscore_mean"
candidates<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7")


custom_control <- trainControl(
  method = "cv",
  number = 30,  # Increase the number of folds
  search = "random",
  allowParallel = TRUE
  
)

param_grid <- expand.grid(
  nrounds = c(50),
  eta = c(0.05),
  max_depth = c(2, 4),
  colsample_bytree = c( 1),
  subsample = c(1),
  gamma = c(0),
  min_child_weight = c(0)
)
```


```{r message = F, warning = F}
thisData[thisData$year%in%IsoYear,] %>% select(Label,candidates) %>% drop_na() -> thisData_2
thisData_2 -> thisData_2_input
  ## create and test models

## test different parameters
xgb_caret <- caret::train(x = thisData_2_input %>% dplyr::select(candidates),
                   y = thisData_2_input %>% pull(Label),
                   method = "xgbTree",
                   verbosity = 0,

                   trControl=custom_control,tuneGrid = param_grid,
                   tuneLength = 2
                    # tuneGrid = expand.grid(nrounds = c(50, 100, 200),
                    #                       eta = c(0.01, 0.05, 0.1),
                    #                       max_depth = c(2, 4),
                    #                       colsample_bytree = c(0.6, 0.8, 1),
                    #                       subsample = c(0.6, 0.8, 1),
                    #                       gamma = c(0, 10, 50),
                    #                       min_child_weight = c(0, 10, 30))
                    )

finalmodel <- caret::train(x = thisData_2_input %>% dplyr::select(-Label, ),
                   y = thisData_2_input %>% pull(Label),
                   method = "xgbTree",
                   verbosity = 0,
                   ## CAST CV LLO (Hanna Meyer)
                   trControl=trainControl(method="cv",
                                          number = 30),
                   # early_stopping_rounds = 10,
                   tuneGrid = xgb_caret$bestTune)

```
```{r}

finalmodel
xgboost::xgb.ggplot.shap.summary(data = as.matrix(thisData_2_input %>% 
  dplyr::select( -Label)),
  model = finalmodel$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "bottom") +
  scale_y_continuous(limits = c(-7, 10), expand = c(0, 0))

final
```
```{r}

```



## b every month
```{r}
excessCounrty_monthly_pvalue 
merge(excessCounrty_monthly_pvalue,ExcessDimred[ExcessDimred$year%in% 2019,],by.x = "iso3",by.y="Country Code")-> thisdate 
thisdate %>% filter(!is.na(iso1))->thisdata2

lm(p_value_mort~iso3.y+iso1+iso2+iso4+iso5+iso6+iso7+iso8+iso9+iso10,thisdata2 %>% filter(year.x%in% 2020,month %in% 6)) %>%  summary

```
#### test if a dimension can predict the estimation methods

```{r}
a<-eval(parse(text = paste0("lm(pscore_mean~",paste(colnames(dimred2021_knn250_2)[6:12],collapse = " + "),",dimred2021_knn250_2[] %>% filter(year%in% 2019))")))
a %>%  summary
```

```{r}

```


