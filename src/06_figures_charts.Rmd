---
title: "06_figures_charts"
author: "Kolja Nenoff"
date: "2023-07-08"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)

```



# 1 Figure Methods dimred compare PCA ISO
## Load 01 data
```{r}

residual_sample_variances <- compute_if_no_file(
  get_data_file("residual_sample_variances.RDS"),
  make_residual_variance_lists,
  qual_comp_res = qual_comp_res,
  wdi_data_cons_df = wdi_data_cons_df,
  used_var_names = USED_VAR_NAMES,
  .overwrite = TRUE
)
```
### template
```{r}


pca_res <- residual_sample_variances$pca
iso_res <- residual_sample_variances$iso
median_res_var_pca <- residual_sample_variances$median_pca
median_res_var_iso <- residual_sample_variances$median_iso
hdi_res_var <- residual_sample_variances$hdi
```
```{r}
plot(pca_res[[1]],
   ylim = c(0, max_res_var_1),
   ## xlim = c(1, max_dim),
   xlim = c(1, 10),
   ylab = "residual variance",
   xlab = "number of dimensions",
   cex.lab = 2,
   las = 1,
   xaxt = "n",
   yaxt = "n",
   bty = "n",
   type = "n")

points(wdi_data_qual_cons_pca,      type = "b",
     lwd = 4, col = lighten("slategrey", 0.8))
points(wdi_data_qual_cons_iso[[2]], type = "b",
     lwd = 4, col = lighten("seagreen", 0.8))
text(1, wdi_data_qual_cons_pca[1],      "PCA",
   pos = 4, offset = 0.5, xpd = TRUE, cex = 2)
text(1, wdi_data_qual_cons_iso[[2]][1], "Ensemble Isomap",
   pos = 4, offset = 0.5, xpd = TRUE, cex = 2)
text(max_x + 0.75,         0.1, "10% Residual Variance", cex = 1.8,
   adj = c(1.1, -0.5), xpd = TRUE)
abline(h = 0.1, col = "gray50", lwd = 2)
par(las = 1, mgp = c(1.5, 0.75, 0))#, xpd = TRUE)
axis(side = 1, at = 1:10, labels = ifelse(1:10 %% 2 == 1, 1:10, ""),
   col = "gray50", col.axis = "gray50",
   cex.axis = 1.5, lwd = 1, tcl = -0.25, lwd.ticks = 2)
axis(side = 2, at = seq(0, 1, length.out = 6),
   col = "gray50", col.axis = "gray50",
   cex.axis = 1.5, lwd = 1, tcl = -0.25, lwd.ticks = 2)
```


# 2 Figure Linear estimation of the exmort
```{r}
require(broom)
require(GGally)
require(ggpubr)
dimred2021_knn250_2<-fread("../output/02_230612_Dimred_ExcessMort_annual.csv")
subset2020<-dimred2021_knn250_2 %>% filter(year%in% 2019) %>% select(year,iso1,iso2,iso3,iso4,iso5,iso6,iso7,iso8,iso9,iso10,year,P_mort_2020) %>% 
  rename(ExcessMort=P_mort_2020) %>% mutate(P_mort_2020=NULL)
subset2021<-dimred2021_knn250_2 %>% filter(year%in% 2020) %>% select(year,iso1,iso2,iso3,iso4,iso5,iso6,iso7,iso8,iso9,iso10,year,P_mort_2021) %>% 
  rename(ExcessMort=P_mort_2021) %>% mutate(P_mort_2020=NULL)
bothyears<-rbind(subset2020,subset2021)
e<-lm(scale(ExcessMort)~iso1+iso2+iso3+iso4+iso5+iso6+iso7,bothyears[]) 
e %>%  summary
ggcoef_model(e)+ ggtitle(paste0("Isomap 2020; R\u00b2: ",e1_rsquared," %"))%>% suppressWarnings()


# for each year
e1<-lm(ExcessMort~iso1+iso2+iso3+iso4+iso5+iso6+iso7+iso8+iso9+iso10,bothyears[] %>% filter(year%in% 2019))
e2<-lm(ExcessMort~iso1+iso2+iso3+iso4+iso5+iso6+iso7+iso8+iso9+iso10,bothyears[] %>% filter(year%in% 2020))
e1_rsquared<-round(summary(e1)$r.squared,digits = 3)*100
e2_rsquared<-round(summary(e2)$r.squared,digits = 3)*100
# 

 e_plot2020<-ggcoef_model(e1)+ ggtitle(paste0("Isomap 2020; R\u00b2: ",e1_rsquared," %"))%>% suppressWarnings()
 e_plot2021<-ggcoef_model(e2)+ ggtitle(paste0("Isomap 2021; R\u00b2: ",e2_rsquared," %")) %>%  suppressWarnings()
plotBoth<-ggarrange(e_plot2020,e_plot2021,common.legend = T,legend = "bottom") %>% suppressWarnings() 
plotBoth
#ggsave("../figures/06_figures_Beta_plot.png",device = "png")
# annotate_figure(plotBoth, top = text_grob("Estimated betas for Isomap 2020 and 2021", 
#                color = "Slategray3", face = "bold", size = 12),bottom = text_grob("asd"))



models <- list(
  "Isomap 2020" = e1,
  "Isomap 2021" = e2
)
# ggcoef_compare(c(models),type = "faceted")+scale_color_viridis()
# ?ggcoef_compare
f<-lm(pscore_mean~iso1+iso2+iso3+iso4+iso5+iso6+iso7+iso8+iso9+iso10+year.x,dimred2021_knn250_2[] %>% filter(year%in% 2019))
f_rsquared<-round(summary(f)$r.squared,digits = 3)*100
f_plot_pscoremean<-ggcoef_model(f)+ ggtitle(paste0("Isomap 2020; R\u00b2: ",f_rsquared," %"))%>% suppressWarnings()
f_plot_pscoremean

a<-eval(parse(text = paste0("lm(pscore_mean~",paste(colnames(dimred2021_knn250_2)[6:12],collapse = " + "),",dimred2021_knn250_2[] %>% filter(year%in% 2019))")))
a %>%  summary
```

# 3 Figure nonlinear isomap types

```{r}
wdi_data_cons_df<-wdi_data_cons_df

featureList<-c("NY.GDP.PCAP.CD","Country Code","P_mort_2020","P_mort_2021","iso1","iso2","iso3","iso4","iso5","iso6","iso7","iso8","iso9","iso10","year","pscore_mean","RegionSoviet","Income Group")
```


## Plot gdp iso 1
```{r}
subset2020<-dimred2021_knn250_2 %>% filter(year%in% 2020) %>% select(any_of(featureList)) %>% rename(ExcessMort=P_mort_2020) %>%  mutate(P_mort_2020=NULL)
subset2021<-dimred2021_knn250_2 %>% filter(year%in% 2021) %>% select(any_of(featureList)) %>% rename(ExcessMort=P_mort_2021) %>% mutate(P_mort_2021=NULL)

bothyears<-rbind(subset2020,subset2021,use.names=FALSE)


bothyears %>% filter(year%in% 2021) %>% mutate(Income_group=`Income Group`) %>% filter(!is.na(Income_group))%>% 
  mutate(Income_group = factor(Income_group, levels=c("High income",
                                      "Upper middle income",
                                      "Lower middle income",
                                      "Low income"
                                      )),`GDP per Capita (log)`=log(NY.GDP.PCAP.CD),
         `Isomap dimension 1`=iso1
         ) %>% 
  
   pivot_longer(names_to = "var",
               c("Isomap dimension 1","GDP per Capita (log)"),
               values_drop_na = TRUE) %>% 
  ggplot(aes(x=(value),y=ExcessMort,color=Income_group))+geom_point()+ theme_bw()+xlab("")+ylab("Excess Mortality") +scale_color_viridis(discrete = T)+facet_wrap(~var,scales = "free_x")+theme(legend.position = "bottom") 
#ggsave("../figures/06_figures_GDP_Iso1.png",device = "png", width = 7, height = 5, dpi = 300, units = "in")
```
## Plot iso 2

### check all the plots
```{r}

wdi_dimred_iso2 %>% filter(!is.na(iso2_all))%>%  mutate(maxdisthighlow=abs(iso2_0to25-iso2_50to75),
                                                        adjustvalue=iso2_75to100/maxdisthighlow) %>% arrange(desc(maxdisthighlow))-> subsetiso2

# for(i in 1:676){
# nameVar<-subsetiso2[i,"Series Code"] %>%  unlist
# applySD<-!is.na(dimred2021_knn250_2[,..nameVar]) %>%  unlist
# 
# wool<-dimred2021_knn250_2[applySD[,1]] %>% filter(year%in% 2010:2021) %>% filter(!is.na(iso2)) %>% 
# ggplot(aes_string(x="iso2",y=paste(nameVar)))+geom_point()
# wool %>% ggsave(file = paste0("../test/run",i,".png",sep=""),device = "png")
# }

```
#### candidates
```{r}
iso2_candidates<-c(5,15,21,26,27,32,49,57,66,68,70,71,80,97,102,119,123,180,207,377,383,407,439,583)
nameVar_iso2_candidates<-subsetiso2[iso2_candidates,"Series Code"] 

for(i in iso2_candidates){
nameVar<-subsetiso2[i,"Series Code"] %>%  unlist
applySD<-!is.na(dimred2021_knn250_2[,..nameVar]) %>%  unlist

wool<-dimred2021_knn250_2[applySD[,1]] %>% filter(year%in% 2010:2021) %>% filter(!is.na(iso2))


wool %>%  mutate(categorie=case_when(scale(iso2)>1.5~"Iso2 peak  high",
                                                 scale(iso2)<  -0.5~"Iso2 peak  Low",
                                                 (scale(iso2)> (-0.5) &scale(iso2)<1.5)~"normal",
                                                  TRUE~"a"
                                                  ))%>% 
  filter(!is.na(get(nameVar)),!is.na(categorie)) -> yo


yo$categorie<-factor(as.factor(yo$categorie),levels=c("Iso2 peak  Low","normal","Iso2 peak  high","a"))
yo2<-yo[,colnames(yo)[colnames(yo)%in% c(paste(nameVar),"categorie")],with=F]
colnames(yo2)[1]<-"value"
series_label<-wdi_explained[wdi_explained$`Series Code` %in% nameVar,"Indicator Name"]

wool2<-ggstatsplot::ggbetweenstats(
  plot.type = "boxviolin",
                            p.adjust.method = "BH",
        point.args = list(alpha = 0),

      data = yo2,
      x = categorie,
      y = value ) + 
      # Add labels and title
      labs(x="",
           y = nameVar,
           title = series_label
      )+theme(
        # This is the new default font in the plot
        text = element_text(family = "Roboto", size = 10, color = "black"),
        plot.title = element_text(
          family = "Lobster Two", 
          size = 14,
          face = "bold",
          color = "#2a475e"
        ),
        # # Statistical annotations below the main title
        plot.subtitle = element_text(
          family = "Roboto",
          face = "bold",
          color="#1b2838"
        ),
        plot.title.position = "plot", # slightly different from default
        axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 12)
      )

wool2 %>% ggsave(file = paste0("../figures/06_iso2plots/",i,".png",sep=""),device = "png")
}

```

### plots
```{r}
featureList<-c("SH.STA.OWGH.ME.ZS","VC.IHR.PSRC.MA.P5","TM.VAL.MRCH.R3.ZS","TX.VAL.MRCH.R2.ZS","SP.DYN.CDRT.IN","SP.POP.2024.FE.5Y","Country Code","P_mort_2020","P_mort_2021","iso1","iso2","iso3","iso4","iso5","iso6","iso7","iso8","iso9","iso10","year","pscore_mean","RegionSoviet","Income Group")


#
# 
# ggsave("../figures/06_figuressa_GDP_Iso1.png",device = "png", width = 7, height = 5, dpi = 300, units = "in")
```
```{r}
dimred2021_knn250_2 %>% filter(year%in% 2019:2021) %>% mutate(Income_group=`Income Group`) %>% filter(!is.na(Income_group)) %>% 
  ggplot(aes(x=(iso2),y=(SP.DYN.CDRT.IN)))+geom_point()+geom_smooth(method = "lm")+ theme_bw()+xlab("Dimension 2")+ylab("Death rate, crude (per 1,000 people)") +scale_color_viridis(discrete = T) 


```
```{r}
dimred2021_knn250_2 %>% filter(year%in% 2019:2021) %>% mutate(Income_group=`Income Group`) %>% filter(!is.na(Income_group)) %>% 
  ggplot(aes(x=(iso2),y=TM.VAL.MRCH.R3.ZS))+geom_point()+geom_smooth(method = "lm")+ theme_bw()+xlab("Dimension 2")+ylab("Merchandise imports from low- and middle-income economies in Latin America & the Caribbean (% of total merchandise imports)") +scale_color_viridis(discrete = T) 
dimred2021_knn250_2 %>% filter(year%in% 2019:2021) %>% mutate(Income_group=`Income Group`) %>% filter(!is.na(Income_group)) %>% 
  ggplot(aes(x=(iso2),y=TX.VAL.MRCH.R2.ZS))+geom_point()+geom_smooth(method = "lm")+ theme_bw()+xlab("Dimension 2")+ylab("Merchandise exports to low- and middle-income economies in Europe & Central Asia (% of total merchandise exports)") +scale_color_viridis(discrete = T) 
```

## Plot iso 1

### check all the plots
```{r}
wdi_dimred_iso1<-fread("../results/corrTable/04_CorrTable_iso1_quantiles_all.csv")
wdi_dimred_iso1 %>% filter(!is.na(iso1_all))%>%  mutate(maxdisthighlow=abs(iso1_0to25-iso1_50to75),
                                                        adjustvalue=iso1_75to100/maxdisthighlow) %>% arrange(desc(maxdisthighlow))-> subsetiso1
```


```{r}
for(i in 1:100){
nameVar<-subsetiso1[i,"Series Code"] %>%  unlist
applySD<-!is.na(dimred2021_knn250_2[,..nameVar]) %>%  unlist

wool<-dimred2021_knn250_2[applySD[,1]] %>% filter(year%in% 2010:2021) %>% filter(!is.na(iso2)) %>%
ggplot(aes_string(x="iso1",y=paste(nameVar)))+geom_point()
wool %>% ggsave(file = paste0("../test/run",i,".png",sep=""),device = "png")
}

```
#### candidates
```{r}
iso1_candidates<-c(24,3,34,58)
nameVar_iso1_candidates<-subsetiso1[iso1_candidates,"Series Code"] 

indicator_a<-nameVar_iso1_candidates$`Series Code`[1]

a<-dimred2021_knn250_2 %>% filter(year%in% 2000:2021) %>% 
  ggplot(aes_string(x="iso1",y=indicator_a))+geom_point(color="firebrick4")+ggtitle(paste(wdi_explained[wdi_explained$`Series Code`%in% indicator_a,"Indicator Name"]))+theme_bw()

indicator_b<-nameVar_iso1_candidates$`Series Code`[2]

b<-dimred2021_knn250_2 %>% filter(year%in% 2000:2021) %>% 
  ggplot(aes_string(x="iso1",y=indicator_b))+geom_point(color="blue4")+ggtitle(paste(wdi_explained[wdi_explained$`Series Code`%in% indicator_b,"Indicator Name"]))+theme_bw()
ggarrange(a,b,ncol = 1) %>% ggsave(file="../figures/06_figures_iso1_nonlinear.png",device = "png", width = 7, height = 5, dpi = 300, units = "in")
```

## Plot iso 4

### check all the plots
```{r}
wdi_dimred_iso4<-fread("../results/corrTable/04_CorrTable_iso4_quantiles_all.csv")
wdi_dimred_iso4 %>% filter(!is.na(iso4_all_all))%>%  mutate(maxdisthighlow=abs(iso4_0to25-iso4_75to100),
                                                        adjustvalue=iso4_50to75/maxdisthighlow) %>% arrange(desc(maxdisthighlow))-> subsetiso4
```


```{r}
for(i in 1:100){
nameVar<-subsetiso4[i,"Series Code"] %>%  unlist
applySD<-!is.na(dimred2021_knn250_2[,..nameVar]) %>%  unlist

wool<-dimred2021_knn250_2[applySD[,1]] %>% filter(year%in% 2010:2021) %>% filter(!is.na(iso4)) %>%
ggplot(aes_string(x="iso4",y=paste(nameVar)))+geom_point()
wool %>% ggsave(file = paste0("../test/run",i,".png",sep=""),device = "png")
}

```
#### candidates
```{r}
iso1_candidates<-c(24,3,34,58)
nameVar_iso1_candidates<-subsetiso1[iso1_candidates,"Series Code"] 

indicator_a<-nameVar_iso1_candidates$`Series Code`[1]

dimred2021_knn250_2 %>% filter(year%in% 2000:2021) %>% 
  ggplot(aes_string(x="iso1",y=indicator_a))+geom_point()+ggtitle(paste(wdi_explained[wdi_explained$`Series Code`%in% indicator_a,"Indicator Name"]))
```


# 4 Shapley values


# 5 Signficant correlated WDI features in a circular plot
`
## all data
```{r}
DATA_DIR<-"../data/"
RELATIVE_INDICATORS_FILE_NAME <- "../data/01_data/relative_indicators_2023_06.R"

order_indidactors<-iso1_onlyDimred$`Series Code` 
dcor_var_iso_cons<-matrix(nrow =length(order_indidactors),ncol=7)
rownames(dcor_var_iso_cons)<-order_indidactors
dcor_var_iso_cons[,1]<-iso1_onlyDimred[iso1_onlyDimred$`Series Code`%in% order_indidactors,"iso1_all"] %>%  unlist
dcor_var_iso_cons[,2]<-iso2_onlyDimred[iso2_onlyDimred$`Series Code`%in% order_indidactors,"iso2_all"] %>%  unlist
dcor_var_iso_cons[,3]<-iso3_onlyDimred[iso3_onlyDimred$`Series Code`%in% order_indidactors,"iso3_all"] %>%  unlist
dcor_var_iso_cons[,4]<-iso4_onlyDimred[iso4_onlyDimred$`Series Code`%in% order_indidactors,"iso4_all"] %>%  unlist
dcor_var_iso_cons[,5]<-iso5_onlyDimred[iso5_onlyDimred$`Series Code`%in% order_indidactors,"iso5_all"] %>%  unlist
dcor_var_iso_cons[,6]<-iso6_onlyDimred[iso6_onlyDimred$`Series Code`%in% order_indidactors,"iso6_all"] %>%  unlist
dcor_var_iso_cons[,7]<-iso7_onlyDimred[iso7_onlyDimred$`Series Code`%in% order_indidactors,"iso7_all"] %>%  unlist


used_var_names_max_dcor <- c(
  dcor_var_iso_cons[, 1] %>% order(decreasing = TRUE) %>% { .[1:15] } %>% { names(dcor_var_iso_cons[., 1]) },
  dcor_var_iso_cons[, 2] %>% order(decreasing = TRUE) %>% { .[1:15] } %>% { names(dcor_var_iso_cons[., 2]) },
  dcor_var_iso_cons[, 3] %>% order(decreasing = TRUE) %>% { .[1:30] } %>% { names(dcor_var_iso_cons[., 3]) },
  dcor_var_iso_cons[, 4] %>% order(decreasing = TRUE) %>% { .[1:30] } %>% { names(dcor_var_iso_cons[., 4]) },
  dcor_var_iso_cons[, 5] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 5]) },
  dcor_var_iso_cons[, 6] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 6]) },
  dcor_var_iso_cons[, 7] %>% order(decreasing = TRUE) %>% { .[1:10]  } %>% {names(dcor_var_iso_cons[., 7]) }
) %>% unique %>% sort
subsetwdi<-wdi_explained[wdi_explained$`Series Code`%in% used_var_names_max_dcor,]

```

#### input
```{r}
source("../libraries/01a_lib_social_indicators.R")
DATA_DIR<-"../data/"
RELATIVE_INDICATORS_FILE_NAME <- "../data/01_data/relative_indicators_2023_06.R"
var_names         = used_var_names_max_dcor
dcor_var_iso_cons = dcor_var_iso_cons
load("../data/wdi_series")
local_wdi_series  = wdi_series[,]



```

#### setup
```{r}




subsetwdi<-wdi_explained[wdi_explained$`Series Code`%in% used_var_names_max_dcor,]

var_names         = used_var_names_max_dcor
dcor_var_iso_cons = dcor_var_iso_cons
load("../data/wdi_series")
local_wdi_series  = wdi_series[,]
expand_multiplier = 1 / 10
text_size         = 5
label_modifier    = manual_label_modifier
col_pal <- c("#1F968B", "#3CBB75", "#7570b3", "#e7298a", "yellow3", "orange","slategrey")
```

### plot function
```{r}

#label_modifier    = short_name_label_modifier,
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 15
.height = 15

component_common <- "Dimension"
component_names <- paste(component_common, 1:7)
xy_expand <- function(xy, expand) xy * (1 + expand * expand_multiplier)
# Does not work
local_wdi_series<-local_wdi_series[grepl(":",local_wdi_series$Topic),]

local_wdi_series <- wdi_series_split_topic(local_wdi_series)

wdi_series_used_important <- local_wdi_series[`Indicator Code` %in% var_names]
var_names<-var_names[var_names%in% wdi_series_used_important$`Indicator Code`]
require(igraph)
stopifnot(length(var_names) == nrow(wdi_series_used_important))
dcor_var_iso_cons_subset<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]
dcor_var_iso_cons<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]



local_wdi_series<-local_wdi_series[local_wdi_series$`Indicator Code`%in% var_names,]
require(tidygraph)
require(ggraph)

dcor_subset<-dcor_var_iso_cons_subset
## local_wdi_series$`Indicator Code`
edges_level_01 <- local_wdi_series %>% select(`Indicator Code`, Topic1) %>%
  unique %>% rename( from = Topic1, to = `Indicator Code`)
edges_level_12 <- local_wdi_series %>% select(Topic1, Topic2)           %>%
  unique %>% rename( from = Topic2, to = Topic1          )
edges_level_23 <- local_wdi_series %>% select(Topic2, Topic3)           %>%
  unique %>% rename( from = Topic3, to = Topic2          )
edges_level_34 <- local_wdi_series %>% select(Topic3, Topic4)           %>%
  unique %>% rename( from = Topic4, to = Topic3          )
edges_level_45 <- local_wdi_series %>% select(Topic4, Topic5)           %>%
  unique %>% rename( from = Topic5, to = Topic4          )
## create the actual igraph object

rbind(edges_level_01, edges_level_12, edges_level_23, edges_level_34,
      edges_level_45) %>%
unique %>%
filter(to != from) ->listi
hier_graph <-listi %>% data.frame() %>%  { .[rev(seq_len(ncol(.)))] } %>% graph_from_data_frame
  ## graph_from_data_frame does not care about column names,
  ## only about positions
  # %>%
  #graph_from_data_frame

## additional data:

graph_idxs <- match(var_names, V(hier_graph)$name)

hier_graph <- set_vertex_attr(hier_graph, "which_max_iso", graph_idxs,
                              dcor_subset %>% apply(1, which.max))
hier_graph <- set_vertex_attr(hier_graph, "dcor_max", graph_idxs,
                              dcor_subset %>% apply(1, max))
hier_graph <- set_vertex_attr(hier_graph, "dcor1", graph_idxs,
                              dcor_subset[, 1])
hier_graph <- set_vertex_attr(hier_graph, "dcor2", graph_idxs,
                              dcor_subset[, 2])
hier_graph <- set_vertex_attr(hier_graph, "dcor3", graph_idxs,
                              dcor_subset[, 3])
hier_graph <- set_vertex_attr(hier_graph, "dcor4", graph_idxs,
                              dcor_subset[, 4])
hier_graph <- set_vertex_attr(hier_graph, "dcor5", graph_idxs,
                              dcor_subset[, 5])
hier_graph <- set_vertex_attr(hier_graph, "dcor6", graph_idxs,
                              dcor_subset[, 6])
hier_graph <- set_vertex_attr(hier_graph, "dcor7", graph_idxs,
                              dcor_subset[, 7])
# 

hier_graph <-
  set_vertex_attr(hier_graph, "Indicator.Code", graph_idxs,
                  local_wdi_series$`Indicator Code`[
                               match(var_names, local_wdi_series$`Indicator Code`)])



# thisPeople<-fread("../data/indicator_compressed_names.csv")
# wdi_names_prepared<-wdi_series_used_important[,c("Indicator Code","Indicator Name")]
# 
# 
# merge(wdi_names_prepared,thisPeople,by="Indicator Code",all.x = T)->wdi_names_prepared2

# wdi_names_prepared2 %>% select(`Indicator Code`,`Indicator Name`,`Compressed Name`)%>%  filter(is.na(`Compressed Name`)) %>% fwrite("../output/preparethenameschatgpt.csv")
# 
# wdi_series_used[,c("Indicator Code","Compressed Name")] #%>% fwrite("../data/indicator_compressed_names.csv")
# # # chatgpt shortened the names
# wdi_series_used
# wdi_series_used2<-fread("../data/indicator_compressed_names.csv")
# shortnames<-fread("../data/05_abbrevationmaker.csv",sep=";")
# rbind(wdi_series_used2[!(wdi_series_used2$`Indicator Code`%in% shortnames$`Indicator Code`)],shortnames) %>%  fwrite("../output/05_indicator_compressed_names.csv")

wdi_series_used<-fread("../data/indicator_compressed_names.csv")

wdi_var_hierarchy_graph <-hier_graph
axis_cons <- lapply(1:7, inner_connections_by_axis,
                       dcor_var_iso_cons       = dcor_var_iso_cons,
                       wdi_var_hierarchy_graph = wdi_var_hierarchy_graph,
                       var_names               = var_names)




expand_multiplier = 1/2
text_size         = 3
label_modifier    = manual_label_modifier
#label_modifier    = short_name_label_modifier
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 50
.height = 50


wdi_var_hierarchy_graph %>%
ggraph(layout = "dendrogram", circular = TRUE) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor1),
                    y = xy_expand(y, dcor1)),
                colour = col_pal[1]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor1),
                 y = xy_expand(y, dcor1)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[1]) +
geom_node_point(aes(filter = leaf,
                   x = xy_expand(x, dcor2),
                    y = xy_expand(y, dcor2)),
                colour = col_pal[2]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor2),
                 y = xy_expand(y, dcor2)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[2]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor3),
                    y = xy_expand(y, dcor3)),
                colour = col_pal[3]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor3),
                 y = xy_expand(y, dcor3)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[3]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor4),
                    y = xy_expand(y, dcor4)),
                colour = col_pal[4]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor4),
                 y = xy_expand(y, dcor4)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[4]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[6]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[6]) +
      geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[7]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[7]) +
geom_node_point(aes(filter = leaf, color = factor(which_max_iso)),
                size = 0)+
geom_node_text(aes(filter = leaf,
                   label  = label_modifier(as.character(Indicator.Code)),
                   color  = factor(paste(component_common, which_max_iso)),
                   x      = x * (1 + 1 * expand_multiplier),
                   y      = y * (1 + 1 * expand_multiplier),
                   hjust  = if_else(x > 0, 0, 1),
                   angle  = atan(y / x) / 2 / pi * 360),
               show.legend = FALSE,
               size        = text_size) +
geom_conn_bundle(data = get_con(axis_cons[[1]][1, ], axis_cons[[1]][2, ]),
                 edge_colour = col_pal[1], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[2]][1, ], axis_cons[[2]][2, ]),
                 edge_colour = col_pal[2], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[3]][1, ], axis_cons[[3]][2, ]),
                 edge_colour = col_pal[3], edge_alpha = 0.3) +
(
  if (ncol(axis_cons[[4]]) > 0)
    geom_conn_bundle(data = get_con(axis_cons[[4]][1, ],
                                    axis_cons[[4]][2, ]),
                     edge_colour = col_pal[4], edge_alpha = 0.3)
  else
    list()
) +
geom_conn_bundle(data = get_con(axis_cons[[5]][1, ], axis_cons[[5]][2, ]),
                 edge_colour = col_pal[5], edge_alpha = 0.3) +
geom_edge_diagonal() +
# geom_node_label(aes(filter = !leaf,
#                     fontface = if_else(name %in% level1, "bold", "plain"),
#                     label = name, angle = atan(y / x) / 2 / pi * 360),
#                 size = 2) +
scale_color_manual(limits = component_names,
                   labels = component_names,
                   values = col_pal) +
guides(colour = guide_legend(title = component_common,
                             override.aes = list(size = 5))) +
theme_void() +
theme(legend.title = element_blank(),
      legend.position = c(0.9, 0.1),
      legend.justification = c(0.9, 0.1)) +
expand_limits(x = c(-2.7, 2.7), y = c(-2.7, 2.7))
# 
ggsave("../figures/05_230711_circle_all_test.pdf",device = "pdf",height = 12,width = 12)

```
## Significant shapleys


### input
#### data

```{r}
DATA_DIR<-"../data/"
RELATIVE_INDICATORS_FILE_NAME <- "../data/01_data/relative_indicators_2023_06.R"

order_indidactors<-iso1_onlyDimred$`Series Code` 
dcor_var_iso_cons<-matrix(nrow =length(order_indidactors),ncol=7)
rownames(dcor_var_iso_cons)<-order_indidactors
dcor_var_iso_cons[,1]<-iso1_onlyDimred[iso1_onlyDimred$`Series Code`%in% order_indidactors,"iso1"] %>%  unlist
dcor_var_iso_cons[,2]<-iso2_onlyDimred[iso2_onlyDimred$`Series Code`%in% order_indidactors,"iso2_75to100_75to100"] %>%  unlist
dcor_var_iso_cons[,3]<-iso3_onlyDimred[iso3_onlyDimred$`Series Code`%in% order_indidactors,"iso3_shapley"] %>%  unlist
dcor_var_iso_cons[,4]<-iso4_onlyDimred[iso4_onlyDimred$`Series Code`%in% order_indidactors,"iso4_shapley"] %>%  unlist
dcor_var_iso_cons[,5]<-iso5_onlyDimred[iso5_onlyDimred$`Series Code`%in% order_indidactors,"iso5_shapley"] %>%  unlist
dcor_var_iso_cons[,6]<-iso6_onlyDimred[iso6_onlyDimred$`Series Code`%in% order_indidactors,"iso6_shapley"] %>%  unlist
dcor_var_iso_cons[,7]<-iso7_onlyDimred[iso7_onlyDimred$`Series Code`%in% order_indidactors,"iso7_shapley"] %>%  unlist
```

#### setup
```{r}


used_var_names_max_dcor <- c(
  dcor_var_iso_cons[, 1] %>% order(decreasing = TRUE) %>% { .[1:10] } %>% { names(dcor_var_iso_cons[., 1]) },
  dcor_var_iso_cons[, 2] %>% order(decreasing = TRUE) %>% { .[1:10] } %>% { names(dcor_var_iso_cons[., 2]) },
  dcor_var_iso_cons[, 3] %>% order(decreasing = TRUE) %>% { .[1:50] } %>% { names(dcor_var_iso_cons[., 3]) },
  dcor_var_iso_cons[, 4] %>% order(decreasing = TRUE) %>% { .[1:50] } %>% { names(dcor_var_iso_cons[., 4]) },
  dcor_var_iso_cons[, 5] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 5]) },
  dcor_var_iso_cons[, 6] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 6]) },
  dcor_var_iso_cons[, 7] %>% order(decreasing = TRUE) %>% { .[1:15]  } %>% {names(dcor_var_iso_cons[., 7]) }
) %>% unique %>% sort

subsetwdi<-wdi_explained[wdi_explained$`Series Code`%in% used_var_names_max_dcor,]

var_names         = used_var_names_max_dcor
dcor_var_iso_cons = dcor_var_iso_cons
load("../data/wdi_series")
local_wdi_series  = wdi_series[,]
expand_multiplier = 1 / 10
text_size         = 5
label_modifier    = manual_label_modifier
col_pal <- c("#1F968B", "#3CBB75", "#7570b3", "#e7298a", "yellow3", "orange","slategrey")
```

#### modifiy the compressed names
```{r}
compressedNames <- fread("../data/indicator_compressed_names.csv")

missingIndicators <- wdi_explained %>%
  filter(`Series Code` %in% used_var_names_max_dcor) %>%
  select(`Series Code`,`Indicator Name`) %>%
  rename(`Indicator Code` = `Series Code`) %>%
  merge(compressedNames[,c("Indicator Code","Compressed Name")], by = "Indicator Code", all.x = TRUE) %>%
  filter(is.na(`Compressed Name`))

missingIndicators

# 
#missingIndicators %>% fwrite("../data/05_abbrevationmaker.csv",sep=";")

#rbind(compressedNames,addthis) %>% fwrite("../data/indicator_compressed_names.csv")
```



### plot function
```{r}

#label_modifier    = short_name_label_modifier,
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 15
.height = 15

component_common <- "Dimension"
component_names <- paste(component_common, 1:7)
xy_expand <- function(xy, expand) xy * (1 + expand * expand_multiplier)
# Does not work
local_wdi_series<-local_wdi_series[grepl(":",local_wdi_series$Topic),]

local_wdi_series <- wdi_series_split_topic(local_wdi_series)

wdi_series_used_important <- local_wdi_series[`Indicator Code` %in% var_names]
var_names<-var_names[var_names%in% wdi_series_used_important$`Indicator Code`]
require(igraph)
stopifnot(length(var_names) == nrow(wdi_series_used_important))
dcor_var_iso_cons_subset<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]
dcor_var_iso_cons<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]



local_wdi_series<-local_wdi_series[local_wdi_series$`Indicator Code`%in% var_names,]
require(tidygraph)
require(ggraph)

dcor_subset<-dcor_var_iso_cons_subset
## local_wdi_series$`Indicator Code`
edges_level_01 <- local_wdi_series %>% select(`Indicator Code`, Topic1) %>%
  unique %>% rename( from = Topic1, to = `Indicator Code`)
edges_level_12 <- local_wdi_series %>% select(Topic1, Topic2)           %>%
  unique %>% rename( from = Topic2, to = Topic1          )
edges_level_23 <- local_wdi_series %>% select(Topic2, Topic3)           %>%
  unique %>% rename( from = Topic3, to = Topic2          )
edges_level_34 <- local_wdi_series %>% select(Topic3, Topic4)           %>%
  unique %>% rename( from = Topic4, to = Topic3          )
edges_level_45 <- local_wdi_series %>% select(Topic4, Topic5)           %>%
  unique %>% rename( from = Topic5, to = Topic4          )
## create the actual igraph object

rbind(edges_level_01, edges_level_12, edges_level_23, edges_level_34,
      edges_level_45) %>%
unique %>%
filter(to != from) ->listi
hier_graph <-listi %>% data.frame() %>%  { .[rev(seq_len(ncol(.)))] } %>% graph_from_data_frame
  ## graph_from_data_frame does not care about column names,
  ## only about positions
  # %>%
  #graph_from_data_frame

## additional data:

graph_idxs <- match(var_names, V(hier_graph)$name)

hier_graph <- set_vertex_attr(hier_graph, "which_max_iso", graph_idxs,
                              dcor_subset %>% apply(1, which.max))
hier_graph <- set_vertex_attr(hier_graph, "dcor_max", graph_idxs,
                              dcor_subset %>% apply(1, max))
hier_graph <- set_vertex_attr(hier_graph, "dcor1", graph_idxs,
                              dcor_subset[, 1])
hier_graph <- set_vertex_attr(hier_graph, "dcor2", graph_idxs,
                              dcor_subset[, 2])
hier_graph <- set_vertex_attr(hier_graph, "dcor3", graph_idxs,
                              dcor_subset[, 3])
hier_graph <- set_vertex_attr(hier_graph, "dcor4", graph_idxs,
                              dcor_subset[, 4])
hier_graph <- set_vertex_attr(hier_graph, "dcor5", graph_idxs,
                              dcor_subset[, 5])
hier_graph <- set_vertex_attr(hier_graph, "dcor6", graph_idxs,
                              dcor_subset[, 6])
hier_graph <- set_vertex_attr(hier_graph, "dcor7", graph_idxs,
                              dcor_subset[, 7])
# 

hier_graph <-
  set_vertex_attr(hier_graph, "Indicator.Code", graph_idxs,
                  local_wdi_series$`Indicator Code`[
                               match(var_names, local_wdi_series$`Indicator Code`)])



# thisPeople<-fread("../data/indicator_compressed_names.csv")
# wdi_names_prepared<-wdi_series_used_important[,c("Indicator Code","Indicator Name")]
# 
# 
# merge(wdi_names_prepared,thisPeople,by="Indicator Code",all.x = T)->wdi_names_prepared2

# wdi_names_prepared2 %>% select(`Indicator Code`,`Indicator Name`,`Compressed Name`)%>%  filter(is.na(`Compressed Name`)) %>% fwrite("../output/preparethenameschatgpt.csv")
# 
# wdi_series_used[,c("Indicator Code","Compressed Name")] #%>% fwrite("../data/indicator_compressed_names.csv")
# # # chatgpt shortened the names
# wdi_series_used
# wdi_series_used2<-fread("../data/indicator_compressed_names.csv")
# shortnames<-fread("../data/05_abbrevationmaker.csv",sep=";")
# rbind(wdi_series_used2[!(wdi_series_used2$`Indicator Code`%in% shortnames$`Indicator Code`)],shortnames) %>%  fwrite("../output/05_indicator_compressed_names.csv")

wdi_series_used<-fread("../data/indicator_compressed_names.csv")

wdi_var_hierarchy_graph <-hier_graph
axis_cons <- lapply(1:7, inner_connections_by_axis,
                       dcor_var_iso_cons       = dcor_var_iso_cons,
                       wdi_var_hierarchy_graph = wdi_var_hierarchy_graph,
                       var_names               = var_names)




expand_multiplier = 1/2
text_size         = 3
label_modifier    = manual_label_modifier
#label_modifier    = short_name_label_modifier
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 50
.height = 50


wdi_var_hierarchy_graph %>%
ggraph(layout = "dendrogram", circular = TRUE) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor1),
                    y = xy_expand(y, dcor1)),
                colour = col_pal[1]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor1),
                 y = xy_expand(y, dcor1)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[1]) +
geom_node_point(aes(filter = leaf,
                   x = xy_expand(x, dcor2),
                    y = xy_expand(y, dcor2)),
                colour = col_pal[2]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor2),
                 y = xy_expand(y, dcor2)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[2]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor3),
                    y = xy_expand(y, dcor3)),
                colour = col_pal[3]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor3),
                 y = xy_expand(y, dcor3)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[3]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor4),
                    y = xy_expand(y, dcor4)),
                colour = col_pal[4]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor4),
                 y = xy_expand(y, dcor4)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[4]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[6]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[6]) +
      geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[7]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[7]) +
geom_node_point(aes(filter = leaf, color = factor(which_max_iso)),
                size = 0)+
geom_node_text(aes(filter = leaf,
                   label  = label_modifier(as.character(Indicator.Code)),
                   color  = factor(paste(component_common, which_max_iso)),
                   x      = x * (1 + 1 * expand_multiplier),
                   y      = y * (1 + 1 * expand_multiplier),
                   hjust  = if_else(x > 0, 0, 1),
                   angle  = atan(y / x) / 2 / pi * 360),
               show.legend = FALSE,
               size        = text_size) +
geom_conn_bundle(data = get_con(axis_cons[[1]][1, ], axis_cons[[1]][2, ]),
                 edge_colour = col_pal[1], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[2]][1, ], axis_cons[[2]][2, ]),
                 edge_colour = col_pal[2], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[3]][1, ], axis_cons[[3]][2, ]),
                 edge_colour = col_pal[3], edge_alpha = 0.3) +
(
  if (ncol(axis_cons[[4]]) > 0)
    geom_conn_bundle(data = get_con(axis_cons[[4]][1, ],
                                    axis_cons[[4]][2, ]),
                     edge_colour = col_pal[4], edge_alpha = 0.3)
  else
    list()
) +
geom_conn_bundle(data = get_con(axis_cons[[5]][1, ], axis_cons[[5]][2, ]),
                 edge_colour = col_pal[5], edge_alpha = 0.3) +
geom_edge_diagonal() +
# geom_node_label(aes(filter = !leaf,
#                     fontface = if_else(name %in% level1, "bold", "plain"),
#                     label = name, angle = atan(y / x) / 2 / pi * 360),
#                 size = 2) +
scale_color_manual(limits = component_names,
                   labels = component_names,
                   values = col_pal) +
guides(colour = guide_legend(title = component_common,
                             override.aes = list(size = 5))) +
theme_void() +
theme(legend.title = element_blank(),
      legend.position = c(0.9, 0.1),
      legend.justification = c(0.9, 0.1)) +
expand_limits(x = c(-2.7, 2.7), y = c(-2.7, 2.7))

ggsave("../figures/05_230711_circle_test2.pdf",device = "pdf",height = 12,width = 12)

```



