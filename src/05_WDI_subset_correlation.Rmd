---
title: "05_WDI_subset_correlation"
author: "Kolja Nenoff"
date: "2023-06-12"
output:
  rmdformats::readthedown:
    code_folding: hide
    self_contained: true
    css: custom.css 
    lightbox: true
    gallery: true
    highlight: tango  
    toc_depth: 5
---

We have described the dimension and their relationship to Excess Mort.
Now we are looing at the subsets and correlate them with the WDI.
The decision will be based on PDP and Shapley values.
We will look for subset for 2020 and 2021

# 0 Data and Methods
```{r,include=T,message=FALSE}
rm(list = ls())
require(xgboost)
require(caret)
require(pdp)
require(iml)
require(data.table)
require(tidyverse)
require(parallel)

```
## Datasets
```{r}
ExcessDimred<-fread("../output/02_230612_Dimred_ExcessMort_annual.csv")
allcorr<-fread("../data/01_CorrWDI_dimred_10.csv")
colnames(allcorr)[2:11]<-paste(colnames(allcorr)[2:11],"_all",sep="")
```

### Load WDI data
```{r}
# wdi_data_raw<-fread("../data/WDI_data_230609/WDI_CSV/WDIData.csv",header = T)
# wdi_data <- wdi_data_raw %>%
#   mutate(...66 = NULL,
#          V67 = NULL,
#          `Indicator Name` = NULL) %>%
#   pivot_longer(names_to = "year",
#                "1960":"2022",
#                values_drop_na = TRUE) %>%
#   mutate(year = as.integer(year)) %>%
#   pivot_wider(names_from = "Indicator Code")
# iso7(wdi_data,"../data/05_WDI_data.csv")
wdi_data<-fread("../data/05_WDI_data.csv")
wdi_explained<-fread("../data/WDI_data_230609/WDI_CSV/WDISeries.csv")
```

## merge to dataset

```{r}
ExcessDimred2<-ExcessDimred%>%  select(`Country Code`,year,iso1,iso2,iso3,iso4,iso5,iso6,iso7,P_mort_2020,P_mort_2021) %>% 
  mutate(identifer=paste0(`Country Code`,"_",year))

                  

wdi_data[,] %>%  mutate(identifer=paste0(`Country Code`,"_",year))-> wdi_data_2
# wer korreliert

corrWDItest<-right_join(wdi_data_2,ExcessDimred2[],by="identifer")
 
```

## Setup cluster
```{r,eval=TRUE}

.cluster <- 30
cl <- parallel::makeCluster(.cluster, outfile = "../data/04_corrLogfile.log")
# on.exit(parallel::stopCluster(cl))
wdi_data_cons_df<-corrWDItest %>% filter(!is.na(iso1))
used_var_names = wdi_explained$`Series Code`[wdi_explained$`Series Code` %in% colnames(corrWDItest)]

```

## Add categories

```{r}
cutoff_for_isos<-fread("../output/07_cutoff_for_latenspace.csv")
```
# 1 Make Correlation WDI ~ Shapley
## subset 2019-2021
```{r}
wdi_data_cons_df %>%  filter(year.x%in% c(2019:2021))-> wdi_data_cons_df
```


## iso 1 

categorie 1 is based on quartiles
categorie 2 is based on the shapley subset in script 04
```{r,eval=FALSE}

group_values<-wdi_data_cons_df$iso1 %>%  quantile()

thisiso<-paste0("iso1")
var_comb <- expand.grid(var_name = used_var_names,
                          iso_name = thisiso,
                          stringsAsFactors = FALSE)

miniso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso1", "min_value"] %>%  unlist() %>% as.numeric()
maxiso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso1", "max_value"] %>%  unlist() %>% as.numeric()


wdi_data_cons_df$iso1 %>%  summary
wdi_data_cons_df %>%  mutate(
  
  categorie=case_when(
  iso1<group_values[2]~"0to25",
  iso1<group_values[3]~"25to50",
  iso1<group_values[4]~"50to75",
  iso1<group_values[5]~"75to100"),
  
  categorie2=if_else(condition=(miniso < iso1 & iso1 < maxiso),true="Shapley_subset",false="normal"))-> wdi_data_cons_df



idx_0_25<-wdi_data_cons_df$categorie%in%"0to25"
idx_25_50<-wdi_data_cons_df$categorie%in%"25to50"
idx_50_75<-wdi_data_cons_df$categorie%in%"50to75"
idx_75_100<-wdi_data_cons_df$categorie%in%"75to100"
idx_shapley<-wdi_data_cons_df$categorie2%in%"Shapley_subset"
parallel::clusterEvalQ(cl, suppressWarnings(library(energy)))
parallel::clusterExport(cl, "wdi_data_cons_df", envir = environment())
parallel::clusterExport(cl, "var_comb", envir = environment())
parallel::clusterExport(cl, "idx_0_25", envir = environment())
parallel::clusterExport(cl, "idx_25_50", envir = environment())
parallel::clusterExport(cl, "idx_50_75", envir = environment())
parallel::clusterExport(cl, "idx_75_100", envir = environment())
parallel::clusterExport(cl, "idx_shapley", envir = environment())
parallel::clusterExport(cl, "miniso", envir = environment())
parallel::clusterExport(cl, "maxiso", envir = environment())


```


```{r,eval=FALSE}
for(groupA in c("idx_0_25","idx_25_50","idx_50_75","idx_75_100","idx_shapley")){
  

variable<-groupA

parallel::clusterExport(cl, "variable", envir = environment())
res <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))

  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
  idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  energy::dcor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx])
  
})

res_Tsamples <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  sum(idx)
})
res_spear <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  cor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx],method = "pearson")
})

wdi_data_cons_dcor <- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor[var_comb$var_name[i],
                     thisiso] <- res[[i]]
}

wdi_data_cons_dcor2<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor2[var_comb$var_name[i],
                       thisiso] <- res_spear[[i]]
}
wdi_data_cons_dcor3<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor3[var_comb$var_name[i],
                       thisiso] <- res_Tsamples[[i]]
}
colnames(wdi_data_cons_dcor2)<-paste("Pearson",colnames(wdi_data_cons_dcor2),sep="_")
colnames(wdi_data_cons_dcor3)<-paste("N",colnames(wdi_data_cons_dcor3),sep="_")

cbind(data.frame(wdi_data_cons_dcor),data.frame(N=wdi_data_cons_dcor3[,1]),wdi_data_cons_dcor2) %>% rownames_to_column(var = "indicators")-> outi
categoriestr<-str_replace(str_remove(groupA,"idx_"),"_","to")


if((groupA%in%"idx_shapley")){
  outi$range<- paste0(round(miniso,digits = 3),"_",round(maxiso,digits = 3))
  
}

if(!(groupA%in%"idx_shapley")){
  outi$range<- paste0(round(min(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3)," to ",
       round(max(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3),sep="")
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")
  
}


eval(parse(text=paste("outi-> WDI_dimred_iso1_",groupA,sep="")))

}

```

```{r,eval=FALSE}
wdi_dimred_iso1<-cbind(WDI_dimred_iso1_idx_0_25,WDI_dimred_iso1_idx_25_50,WDI_dimred_iso1_idx_50_75,WDI_dimred_iso1_idx_75_100,WDI_dimred_iso1_idx_shapley)
wdi_dimred_iso1_1<-data.frame("Indicators"=wdi_dimred_iso1$indicators_0to25,wdi_dimred_iso1[,!grepl("indicators",colnames(wdi_dimred_iso1))])

wdi_dimred_iso1_2<-merge(allcorr,wdi_dimred_iso1_1,by="Indicators",all.y=T)
wdi_dimred_iso1_3<-merge(wdi_explained[,c("Series Code","Topic","Indicator Name")],wdi_dimred_iso1_2,by.x="Series Code",by.y="Indicators")
#fwrite(wdi_dimred_iso1_3,"../results/corrTable/05_CorrTable_iso1_quantiles_shapleys_2019to2021_all.csv")
```


```{r}
iso1_corr<-fread("../results/corrTable/05_CorrTable_iso1_quantiles_shapleys_all.csv")



```

## iso 2

```{r,eval=FALSE}
group_values<-wdi_data_cons_df$iso2 %>%  quantile()

thisiso<-paste0("iso2")
var_comb <- expand.grid(var_name = used_var_names,
                          iso_name = thisiso,
                          stringsAsFactors = FALSE)



miniso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso2", "min_value"] %>%  unlist() %>% as.numeric()
maxiso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso2", "max_value"] %>%  unlist() %>% as.numeric()

wdi_data_cons_df$iso2 %>%  summary
wdi_data_cons_df %>%  mutate(
  
  categorie=case_when(
  iso3<group_values[2]~"0to25",
  iso3<group_values[3]~"25to50",
  iso3<group_values[4]~"50to75",
  iso3<group_values[5]~"75to100"),
  
  categorie2=if_else(condition=(miniso <= iso2),true="Shapley_subset",false="normal"))-> wdi_data_cons_df

wdi_data_cons_df$categorie2 %>%  table



idx_0_25<-wdi_data_cons_df$categorie%in%"0to25"
idx_25_50<-wdi_data_cons_df$categorie%in%"25to50"
idx_50_75<-wdi_data_cons_df$categorie%in%"50to75"
idx_75_100<-wdi_data_cons_df$categorie%in%"75to100"
idx_shapley<-wdi_data_cons_df$categorie2%in%"Shapley_subset"
parallel::clusterEvalQ(cl, suppressWarnings(library(energy)))
parallel::clusterExport(cl, "wdi_data_cons_df", envir = environment())
parallel::clusterExport(cl, "var_comb", envir = environment())
parallel::clusterExport(cl, "idx_0_25", envir = environment())
parallel::clusterExport(cl, "idx_25_50", envir = environment())
parallel::clusterExport(cl, "idx_50_75", envir = environment())
parallel::clusterExport(cl, "idx_75_100", envir = environment())
parallel::clusterExport(cl, "idx_shapley", envir = environment())
parallel::clusterExport(cl, "miniso", envir = environment())
parallel::clusterExport(cl, "maxiso", envir = environment())
```


```{r,eval=F}
for(groupA in c("idx_0_25","idx_25_50","idx_50_75","idx_75_100","idx_shapley")){
  

variable<-groupA

parallel::clusterExport(cl, "variable", envir = environment())
res <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))

  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
  idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  energy::dcor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx])
  
})

res_Tsamples <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  sum(idx)
})
res_spear <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  cor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx],method = "pearson")
})

wdi_data_cons_dcor <- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor[var_comb$var_name[i],
                     thisiso] <- res[[i]]
}

wdi_data_cons_dcor2<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor2[var_comb$var_name[i],
                       thisiso] <- res_spear[[i]]
}
wdi_data_cons_dcor3<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor3[var_comb$var_name[i],
                       thisiso] <- res_Tsamples[[i]]
}
colnames(wdi_data_cons_dcor2)<-paste("Pearson",colnames(wdi_data_cons_dcor2),sep="_")
colnames(wdi_data_cons_dcor3)<-paste("N",colnames(wdi_data_cons_dcor3),sep="_")

cbind(data.frame(wdi_data_cons_dcor),data.frame(N=wdi_data_cons_dcor3[,1]),wdi_data_cons_dcor2) %>% rownames_to_column(var = "indicators")-> outi
categoriestr<-str_replace(str_remove(groupA,"idx_"),"_","to")

if((groupA%in%"idx_shapley")){
  outi$range<- paste0(round(miniso,digits = 3),"_",round(maxiso,digits = 3))
  
}

if(!(groupA%in%"idx_shapley")){
  outi$range<- paste0(round(min(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3)," to ",
       round(max(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3),sep="")
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")
  
}



colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")

eval(parse(text=paste("outi-> WDI_dimred_iso2_",groupA,sep="")))

}

```

```{r,eval=FALSE}
wdi_dimred_iso2<-cbind(WDI_dimred_iso2_idx_0_25,WDI_dimred_iso2_idx_25_50,WDI_dimred_iso2_idx_50_75,WDI_dimred_iso2_idx_75_100,WDI_dimred_iso2_idx_shapley)
wdi_dimred_iso2_1<-data.frame("Indicators"=wdi_dimred_iso2$indicators_0to25,wdi_dimred_iso2[,!grepl("indicators",colnames(wdi_dimred_iso2))])

wdi_dimred_iso2_2<-merge(allcorr,wdi_dimred_iso2_1,by="Indicators",all.y=T)
wdi_dimred_iso2_3<-merge(wdi_explained[,c("Series Code","Topic","Indicator Name")],wdi_dimred_iso2_2,by.x="Series Code",by.y="Indicators")
#fwrite(wdi_dimred_iso2_3,"../results/corrTable/05_CorrTable_iso2_quantiles_shapleys_2019to2021_all.csv")
```




## iso 3 

```{r,eval=FALSE}
group_values<-wdi_data_cons_df$iso3 %>%  quantile()
thisiso<-paste0("iso3")
var_comb <- expand.grid(var_name = used_var_names,
                          iso_name = thisiso,
                          stringsAsFactors = FALSE)

miniso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso3", "min_value"] %>%  unlist() %>% as.numeric()
maxiso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso3", "max_value"] %>%  unlist() %>% as.numeric()
wdi_data_cons_df$iso3 %>%  summary
wdi_data_cons_df %>%  mutate(
  
  categorie=case_when(
  iso3<group_values[2]~"0to25",
  iso3<group_values[3]~"25to50",
  iso3<group_values[4]~"50to75",
  iso3<group_values[5]~"75to100"),
  
  categorie2=if_else(condition=(miniso < iso3 & iso3 < maxiso),,true="Shapley_subset",false="normal"))-> wdi_data_cons_df

wdi_data_cons_df$categorie2 %>%  table



idx_0_25<-wdi_data_cons_df$categorie%in%"0to25"
idx_25_50<-wdi_data_cons_df$categorie%in%"25to50"
idx_50_75<-wdi_data_cons_df$categorie%in%"50to75"
idx_75_100<-wdi_data_cons_df$categorie%in%"75to100"
idx_shapley<-wdi_data_cons_df$categorie2%in%"Shapley_subset"
parallel::clusterEvalQ(cl, suppressWarnings(library(energy)))
parallel::clusterExport(cl, "wdi_data_cons_df", envir = environment())
parallel::clusterExport(cl, "var_comb", envir = environment())
parallel::clusterExport(cl, "idx_0_25", envir = environment())
parallel::clusterExport(cl, "idx_25_50", envir = environment())
parallel::clusterExport(cl, "idx_50_75", envir = environment())
parallel::clusterExport(cl, "idx_75_100", envir = environment())
parallel::clusterExport(cl, "idx_shapley", envir = environment())
parallel::clusterExport(cl, "miniso", envir = environment())
parallel::clusterExport(cl, "maxiso", envir = environment())
```


```{r,eval=F}
for(groupA in c("idx_0_25","idx_25_50","idx_50_75","idx_75_100","idx_shapley")){
  

variable<-groupA

parallel::clusterExport(cl, "variable", envir = environment())
res <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))

  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
  idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  energy::dcor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx])
  
})

res_Tsamples <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  sum(idx)
})
res_spear <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  cor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx],method = "pearson")
})

wdi_data_cons_dcor <- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor[var_comb$var_name[i],
                     thisiso] <- res[[i]]
}

wdi_data_cons_dcor2<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor2[var_comb$var_name[i],
                       thisiso] <- res_spear[[i]]
}
wdi_data_cons_dcor3<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor3[var_comb$var_name[i],
                       thisiso] <- res_Tsamples[[i]]
}
colnames(wdi_data_cons_dcor2)<-paste("Pearson",colnames(wdi_data_cons_dcor2),sep="_")
colnames(wdi_data_cons_dcor3)<-paste("N",colnames(wdi_data_cons_dcor3),sep="_")

cbind(data.frame(wdi_data_cons_dcor),data.frame(N=wdi_data_cons_dcor3[,1]),wdi_data_cons_dcor2) %>% rownames_to_column(var = "indicators")-> outi
categoriestr<-str_replace(str_remove(groupA,"idx_"),"_","to")


if((groupA%in%"idx_shapley")){
  outi$range<- paste0(round(miniso,digits = 3),"_",round(maxiso,digits = 3))
  
}

if(!(groupA%in%"idx_shapley")){
  outi$range<- paste0(round(min(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3)," to ",
       round(max(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3),sep="")
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")
  
}
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")

eval(parse(text=paste("outi-> WDI_dimred_iso3_",groupA,sep="")))

}

```

```{r,eval=FALSE}
wdi_dimred_iso3<-cbind(WDI_dimred_iso3_idx_0_25,WDI_dimred_iso3_idx_25_50,WDI_dimred_iso3_idx_50_75,WDI_dimred_iso3_idx_75_100,WDI_dimred_iso3_idx_shapley)
wdi_dimred_iso3_1<-data.frame("Indicators"=wdi_dimred_iso3$indicators_0to25,wdi_dimred_iso3[,!grepl("indicators",colnames(wdi_dimred_iso3))])


wdi_dimred_iso3_2<-merge(allcorr,wdi_dimred_iso3_1,by="Indicators",all.y=T)
wdi_dimred_iso3_3<-merge(wdi_explained[,c("Series Code","Topic","Indicator Name")],wdi_dimred_iso3_2,by.x="Series Code",by.y="Indicators")
#fwrite(wdi_dimred_iso3_3,"../results/corrTable/04_CorrTable_iso3_quantiles_shapleys_2019to2021_all.csv")
```

```{r}
iso3_corrtable<-fread("../results/corrTable/04_CorrTable_iso3_quantiles_shapleys_all.csv")

```


## iso 4 

```{r,eval=FALSE}
group_values<-wdi_data_cons_df$iso4 %>%  quantile()
thisiso<-paste0("iso4")
var_comb <- expand.grid(var_name = used_var_names,
                          iso_name = thisiso,
                          stringsAsFactors = FALSE)

miniso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso4", "min_value"] %>%  unlist() %>% as.numeric()

maxiso<-cutoff_for_isos[cutoff_for_isos$name %in% "iso4", "max_value"] %>%  unlist() %>% as.numeric()
wdi_data_cons_df$iso4 %>%  summary
wdi_data_cons_df %>%  mutate(
  
  categorie=case_when(
  iso4<group_values[2]~"0to25",
  iso4<group_values[3]~"25to50",
  iso4<group_values[4]~"50to75",
  iso4<group_values[5]~"75to100"),
  
  categorie2=if_else(condition=(miniso < iso4 & iso4 < maxiso),,true="Shapley_subset",false="normal"))-> wdi_data_cons_df

wdi_data_cons_df$categorie2 %>%  table



idx_0_25<-wdi_data_cons_df$categorie%in%"0to25"
idx_25_50<-wdi_data_cons_df$categorie%in%"25to50"
idx_50_75<-wdi_data_cons_df$categorie%in%"50to75"
idx_75_100<-wdi_data_cons_df$categorie%in%"75to100"
idx_shapley<-wdi_data_cons_df$categorie2%in%"Shapley_subset"
parallel::clusterEvalQ(cl, suppressWarnings(library(energy)))
parallel::clusterExport(cl, "wdi_data_cons_df", envir = environment())
parallel::clusterExport(cl, "var_comb", envir = environment())
parallel::clusterExport(cl, "idx_0_25", envir = environment())
parallel::clusterExport(cl, "idx_25_50", envir = environment())
parallel::clusterExport(cl, "idx_50_75", envir = environment())
parallel::clusterExport(cl, "idx_75_100", envir = environment())
parallel::clusterExport(cl, "idx_shapley", envir = environment())
parallel::clusterExport(cl, "miniso", envir = environment())
parallel::clusterExport(cl, "maxiso", envir = environment())
```


```{r,eval=F}
for(groupA in c("idx_0_25","idx_25_50","idx_50_75","idx_75_100","idx_shapley")){
  

variable<-groupA

parallel::clusterExport(cl, "variable", envir = environment())
res <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))

  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
  idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  energy::dcor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx])
  
})

res_Tsamples <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  sum(idx)
})
res_spear <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  cor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx],method = "pearson")
})

wdi_data_cons_dcor <- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor[var_comb$var_name[i],
                     thisiso] <- res[[i]]
}

wdi_data_cons_dcor2<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor2[var_comb$var_name[i],
                       thisiso] <- res_spear[[i]]
}
wdi_data_cons_dcor3<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor3[var_comb$var_name[i],
                       thisiso] <- res_Tsamples[[i]]
}
colnames(wdi_data_cons_dcor2)<-paste("Pearson",colnames(wdi_data_cons_dcor2),sep="_")
colnames(wdi_data_cons_dcor3)<-paste("N",colnames(wdi_data_cons_dcor3),sep="_")

cbind(data.frame(wdi_data_cons_dcor),data.frame(N=wdi_data_cons_dcor3[,1]),wdi_data_cons_dcor2) %>% rownames_to_column(var = "indicators")-> outi
categoriestr<-str_replace(str_remove(groupA,"idx_"),"_","to")


if((groupA%in%"idx_shapley")){
  outi$range<- paste0(round(miniso,digits = 3),"_",round(maxiso,digits = 3))
  
}

if(!(groupA%in%"idx_shapley")){
  outi$range<- paste0(round(min(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3)," to ",
       round(max(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3),sep="")
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")
  
}
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")

eval(parse(text=paste("outi-> WDI_dimred_iso4_",groupA,sep="")))

}

```

```{r,eval=FALSE}
wdi_dimred_iso4<-cbind(WDI_dimred_iso4_idx_0_25,WDI_dimred_iso4_idx_25_50,WDI_dimred_iso4_idx_50_75,WDI_dimred_iso4_idx_75_100,WDI_dimred_iso4_idx_shapley)
wdi_dimred_iso4_1<-data.frame("Indicators"=wdi_dimred_iso4$indicators_0to25,wdi_dimred_iso4[,!grepl("indicators",colnames(wdi_dimred_iso4))])

wdi_dimred_iso4_2<-merge(allcorr,wdi_dimred_iso4_1,by="Indicators",all.y=T)
wdi_dimred_iso4_3<-merge(wdi_explained[,c("Series Code","Topic","Indicator Name")],wdi_dimred_iso4_2,by.x="Series Code",by.y="Indicators")
#fwrite(wdi_dimred_iso4_3,"../results/corrTable/04_CorrTable_iso4_quantiles_shapley_2019to2021_all.csv")
```

```{r}
iso4_corrtable<-fread("../results/corrTable/04_CorrTable_iso4_quantiles_shapley_all.csv")

```

## iso 5

```{r,eval=FALSE}
group_values<-wdi_data_cons_df$iso5 %>%  quantile()
thisiso<-paste0("iso5")
var_comb <- expand.grid(var_name = used_var_names,
                          iso_name = thisiso,
                          stringsAsFactors = FALSE)

miniso<-cutoff_for_isos[cutoff_for_isos$name %in% thisiso, "min_value"] %>%  unlist() %>% as.numeric()

maxiso<-cutoff_for_isos[cutoff_for_isos$name %in% thisiso, "max_value"] %>%  unlist() %>% as.numeric()
wdi_data_cons_df$iso5 %>%  summary

wdi_data_cons_df %>%  mutate(
  
  categorie=case_when(
  get(thisiso)<group_values[2]~"0to25",
  get(thisiso)<group_values[3]~"25to50",
  get(thisiso)<group_values[4]~"50to75",
  get(thisiso)<group_values[5]~"75to100"),
  
  categorie2=if_else(condition=(miniso < get(thisiso) & get(thisiso) < maxiso),,true="Shapley_subset",false="normal"))-> wdi_data_cons_df

wdi_data_cons_df$categorie2 %>%  table


idx_0_25<-wdi_data_cons_df$categorie%in%"0to25"
idx_25_50<-wdi_data_cons_df$categorie%in%"25to50"
idx_50_75<-wdi_data_cons_df$categorie%in%"50to75"
idx_75_100<-wdi_data_cons_df$categorie%in%"75to100"
idx_shapley<-wdi_data_cons_df$categorie2%in%"Shapley_subset"
parallel::clusterEvalQ(cl, suppressWarnings(library(energy)))
parallel::clusterExport(cl, "wdi_data_cons_df", envir = environment())
parallel::clusterExport(cl, "var_comb", envir = environment())
parallel::clusterExport(cl, "idx_0_25", envir = environment())
parallel::clusterExport(cl, "idx_25_50", envir = environment())
parallel::clusterExport(cl, "idx_50_75", envir = environment())
parallel::clusterExport(cl, "idx_75_100", envir = environment())
parallel::clusterExport(cl, "idx_shapley", envir = environment())
parallel::clusterExport(cl, "miniso", envir = environment())
parallel::clusterExport(cl, "maxiso", envir = environment())
```


```{r,eval=F}
for(groupA in c("idx_0_25","idx_25_50","idx_50_75","idx_75_100","idx_shapley")){

variable<-groupA

parallel::clusterExport(cl, "variable", envir = environment())
res <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))

  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
  idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  energy::dcor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx])
  
})

res_Tsamples <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  sum(idx)
})
res_spear <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  cor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx],method = "pearson")
})

wdi_data_cons_dcor <- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor[var_comb$var_name[i],
                     thisiso] <- res[[i]]
}

wdi_data_cons_dcor2<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor2[var_comb$var_name[i],
                       thisiso] <- res_spear[[i]]
}
wdi_data_cons_dcor3<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor3[var_comb$var_name[i],
                       thisiso] <- res_Tsamples[[i]]
}
colnames(wdi_data_cons_dcor2)<-paste("Pearson",colnames(wdi_data_cons_dcor2),sep="_")
colnames(wdi_data_cons_dcor3)<-paste("N",colnames(wdi_data_cons_dcor3),sep="_")

cbind(data.frame(wdi_data_cons_dcor),data.frame(N=wdi_data_cons_dcor3[,1]),wdi_data_cons_dcor2) %>% rownames_to_column(var = "indicators")-> outi
categoriestr<-str_replace(str_remove(groupA,"idx_"),"_","to")



if((groupA%in%"idx_shapley")){
  outi$range<- paste0(round(miniso,digits = 3),"_",round(maxiso,digits = 3))
  
}

if(!(groupA%in%"idx_shapley")){
  outi$range<- paste0(round(min(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3)," to ",
       round(max(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3),sep="")
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")
  
}
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")

eval(parse(text=paste("outi-> WDI_dimred_iso5_",groupA,sep="")))

}

```

```{r,eval=FALSE}
wdi_dimred_iso5<-cbind(WDI_dimred_iso5_idx_0_25,WDI_dimred_iso5_idx_25_50,WDI_dimred_iso5_idx_50_75,WDI_dimred_iso5_idx_75_100,WDI_dimred_iso5_idx_shapley)
wdi_dimred_iso5_1<-data.frame("Indicators"=wdi_dimred_iso5$indicators_0to25,wdi_dimred_iso5[,!grepl("indicators",colnames(wdi_dimred_iso5))])

wdi_dimred_iso5_2<-merge(allcorr,wdi_dimred_iso5_1,by="Indicators",all.y=T)
wdi_dimred_iso5_3<-merge(wdi_explained[,c("Series Code","Topic","Indicator Name")],wdi_dimred_iso5_2,by.x="Series Code",by.y="Indicators")
#fwrite(wdi_dimred_iso5_3,"../results/corrTable/04_CorrTable_iso5_quantiles_shapley_2019to2021_all.csv")
```

## iso 6

```{r,eval=FALSE}
group_values<-wdi_data_cons_df$iso6 %>%  quantile()
thisiso<-paste0("iso6")
var_comb <- expand.grid(var_name = used_var_names,
                          iso_name = thisiso,
                          stringsAsFactors = FALSE)

miniso<-cutoff_for_isos[cutoff_for_isos$name %in% thisiso, "min_value"] %>%  unlist() %>% as.numeric()
maxiso<-cutoff_for_isos[cutoff_for_isos$name %in% thisiso, "max_value"] %>%  unlist() %>% as.numeric()
wdi_data_cons_df$iso6 %>%  summary

wdi_data_cons_df %>%  mutate(
  
  categorie=case_when(
  get(thisiso)<group_values[2]~"0to25",
  get(thisiso)<group_values[3]~"25to50",
  get(thisiso)<group_values[4]~"50to75",
  get(thisiso)<group_values[5]~"75to100"),
  
  categorie2=if_else(condition=(miniso < get(thisiso) & get(thisiso) < maxiso),,true="Shapley_subset",false="normal"))-> wdi_data_cons_df

wdi_data_cons_df$categorie2 %>%  table


idx_0_25<-wdi_data_cons_df$categorie%in%"0to25"
idx_25_50<-wdi_data_cons_df$categorie%in%"25to50"
idx_50_75<-wdi_data_cons_df$categorie%in%"50to75"
idx_75_100<-wdi_data_cons_df$categorie%in%"75to100"
idx_shapley<-wdi_data_cons_df$categorie2%in%"Shapley_subset"
parallel::clusterEvalQ(cl, suppressWarnings(library(energy)))
parallel::clusterExport(cl, "wdi_data_cons_df", envir = environment())
parallel::clusterExport(cl, "var_comb", envir = environment())
parallel::clusterExport(cl, "idx_0_25", envir = environment())
parallel::clusterExport(cl, "idx_25_50", envir = environment())
parallel::clusterExport(cl, "idx_50_75", envir = environment())
parallel::clusterExport(cl, "idx_75_100", envir = environment())
parallel::clusterExport(cl, "idx_shapley", envir = environment())
parallel::clusterExport(cl, "miniso", envir = environment())
parallel::clusterExport(cl, "maxiso", envir = environment())
```


```{r,eval=F}
for(groupA in c("idx_0_25","idx_25_50","idx_50_75","idx_75_100","idx_shapley")){

variable<-groupA

parallel::clusterExport(cl, "variable", envir = environment())
res <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))

  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
  idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  energy::dcor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx])
  
})

res_Tsamples <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  sum(idx)
})
res_spear <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  cor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx],method = "pearson")
})

wdi_data_cons_dcor <- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor[var_comb$var_name[i],
                     thisiso] <- res[[i]]
}

wdi_data_cons_dcor2<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor2[var_comb$var_name[i],
                       thisiso] <- res_spear[[i]]
}
wdi_data_cons_dcor3<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor3[var_comb$var_name[i],
                       thisiso] <- res_Tsamples[[i]]
}
colnames(wdi_data_cons_dcor2)<-paste("Pearson",colnames(wdi_data_cons_dcor2),sep="_")
colnames(wdi_data_cons_dcor3)<-paste("N",colnames(wdi_data_cons_dcor3),sep="_")

cbind(data.frame(wdi_data_cons_dcor),data.frame(N=wdi_data_cons_dcor3[,1]),wdi_data_cons_dcor2) %>% rownames_to_column(var = "indicators")-> outi
categoriestr<-str_replace(str_remove(groupA,"idx_"),"_","to")



if((groupA%in%"idx_shapley")){
  outi$range<- paste0(round(miniso,digits = 3),"_",round(maxiso,digits = 3))
  
}

if(!(groupA%in%"idx_shapley")){
  outi$range<- paste0(round(min(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3)," to ",
       round(max(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3),sep="")
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")
  
}
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")

eval(parse(text=paste("outi-> WDI_dimred_iso6_",groupA,sep="")))

}

```

```{r,eval=FALSE}
wdi_dimred_iso6<-cbind(WDI_dimred_iso6_idx_0_25,WDI_dimred_iso6_idx_25_50,WDI_dimred_iso6_idx_50_75,WDI_dimred_iso6_idx_75_100,WDI_dimred_iso6_idx_shapley)
wdi_dimred_iso6_1<-data.frame("Indicators"=wdi_dimred_iso6$indicators_0to25,wdi_dimred_iso6[,!grepl("indicators",colnames(wdi_dimred_iso6))])



wdi_dimred_iso6_2<-merge(allcorr,wdi_dimred_iso6_1,by="Indicators",all.y=T)
wdi_dimred_iso6_3<-merge(wdi_explained[,c("Series Code","Topic","Indicator Name")],wdi_dimred_iso6_2,by.x="Series Code",by.y="Indicators")
#fwrite(wdi_dimred_iso6_3,"../results/corrTable/04_CorrTable_iso6_quantiles_shapley_2019to2021_all.csv")
```



## iso 7

```{r,eval=FALSE}
group_values<-wdi_data_cons_df$iso7 %>%  quantile()
thisiso<-paste0("iso7")
var_comb <- expand.grid(var_name = used_var_names,
                          iso_name = thisiso,
                          stringsAsFactors = FALSE)

miniso<-cutoff_for_isos[cutoff_for_isos$name %in% thisiso, "min_value"] %>%  unlist() %>% as.numeric()
maxiso<-cutoff_for_isos[cutoff_for_isos$name %in% thisiso, "max_value"] %>%  unlist() %>% as.numeric()
wdi_data_cons_df$iso7 %>%  summary

wdi_data_cons_df %>%  mutate(
  
  categorie=case_when(
  get(thisiso)<group_values[2]~"0to25",
  get(thisiso)<group_values[3]~"25to50",
  get(thisiso)<group_values[4]~"50to75",
  get(thisiso)<group_values[5]~"75to100"),
  
  categorie2=if_else(condition=(miniso < get(thisiso) & get(thisiso) < maxiso),,true="Shapley_subset",false="normal"))-> wdi_data_cons_df

wdi_data_cons_df$categorie2 %>%  table


idx_0_25<-wdi_data_cons_df$categorie%in%"0to25"
idx_25_50<-wdi_data_cons_df$categorie%in%"25to50"
idx_50_75<-wdi_data_cons_df$categorie%in%"50to75"
idx_75_100<-wdi_data_cons_df$categorie%in%"75to100"
idx_shapley<-wdi_data_cons_df$categorie2%in%"Shapley_subset"
parallel::clusterEvalQ(cl, suppressWarnings(library(energy)))
parallel::clusterExport(cl, "wdi_data_cons_df", envir = environment())
parallel::clusterExport(cl, "var_comb", envir = environment())
parallel::clusterExport(cl, "idx_0_25", envir = environment())
parallel::clusterExport(cl, "idx_25_50", envir = environment())
parallel::clusterExport(cl, "idx_50_75", envir = environment())
parallel::clusterExport(cl, "idx_75_100", envir = environment())
parallel::clusterExport(cl, "idx_shapley", envir = environment())
parallel::clusterExport(cl, "miniso", envir = environment())
parallel::clusterExport(cl, "maxiso", envir = environment())
```


```{r,eval=F}
for(groupA in c("idx_0_25","idx_25_50","idx_50_75","idx_75_100","idx_shapley")){

variable<-groupA

parallel::clusterExport(cl, "variable", envir = environment())
res <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))

  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
  idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  energy::dcor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx])
  
})

res_Tsamples <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  sum(idx)
})
res_spear <- parLapplyLB(cl, 1:nrow(var_comb), function (i) {
  message("i: ", i, " / ", nrow(var_comb))
  idx <- !is.na(wdi_data_cons_df[[var_comb$var_name[i]]])
   idx<-eval(parse(text=paste0("idx&",variable,sep="")))
  cor(wdi_data_cons_df[[var_comb$var_name[i]]][idx],
               wdi_data_cons_df[[var_comb$iso_name[i]]][idx],method = "pearson")
})

wdi_data_cons_dcor <- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor[var_comb$var_name[i],
                     thisiso] <- res[[i]]
}

wdi_data_cons_dcor2<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor2[var_comb$var_name[i],
                       thisiso] <- res_spear[[i]]
}
wdi_data_cons_dcor3<- matrix(
  NA_real_, length(used_var_names), 1,
  dimnames = list(used_var_names, thisiso)
)
for (i in seq_len(nrow(var_comb))) {
  wdi_data_cons_dcor3[var_comb$var_name[i],
                       thisiso] <- res_Tsamples[[i]]
}
colnames(wdi_data_cons_dcor2)<-paste("Pearson",colnames(wdi_data_cons_dcor2),sep="_")
colnames(wdi_data_cons_dcor3)<-paste("N",colnames(wdi_data_cons_dcor3),sep="_")

cbind(data.frame(wdi_data_cons_dcor),data.frame(N=wdi_data_cons_dcor3[,1]),wdi_data_cons_dcor2) %>% rownames_to_column(var = "indicators")-> outi
categoriestr<-str_replace(str_remove(groupA,"idx_"),"_","to")



if((groupA%in%"idx_shapley")){
  outi$range<- paste0(round(miniso,digits = 3),"_",round(maxiso,digits = 3))
  
}

if(!(groupA%in%"idx_shapley")){
  outi$range<- paste0(round(min(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3)," to ",
       round(max(wdi_data_cons_df[wdi_data_cons_df$categorie%in%categoriestr,..thisiso]),digits = 3),sep="")
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")
  
}
colnames(outi)<-paste(colnames(outi),categoriestr,sep = "_")

eval(parse(text=paste("outi-> WDI_dimred_iso7_",groupA,sep="")))

}

```

```{r,eval=FALSE}
wdi_dimred_iso7<-cbind(WDI_dimred_iso7_idx_0_25,WDI_dimred_iso7_idx_25_50,WDI_dimred_iso7_idx_50_75,WDI_dimred_iso7_idx_75_100,WDI_dimred_iso7_idx_shapley)
wdi_dimred_iso7_1<-data.frame("Indicators"=wdi_dimred_iso7$indicators_0to25,wdi_dimred_iso7[,!grepl("indicators",colnames(wdi_dimred_iso7))])



wdi_dimred_iso7_2<-merge(allcorr,wdi_dimred_iso7_1,by="Indicators",all.y=T)
wdi_dimred_iso7_3<-merge(wdi_explained[,c("Series Code","Topic","Indicator Name")],wdi_dimred_iso7_2,by.x="Series Code",by.y="Indicators")
#fwrite(wdi_dimred_iso7_3,"../results/corrTable/04_CorrTable_iso7_quantiles_shapley_2019to2021_all.csv")
```


# 2 Detect highest correlation

## iso 1
```{r}
iso1allcors<-fread("../results/corrTable/05_CorrTable_iso1_quantiles_shapleys_2019to2021_all.csv")
iso1allcors %>% filter(!is.na(iso1_all)) ->iso1_onlyDimred
iso1_onlyDimred  %>%  ggplot(aes(iso1_all))+geom_histogram(bins = 100)
iso1_onlyDimred  %>% ggplot(aes(iso1))+geom_histogram(bins = 100)
summary_iso1<-summary(iso1_onlyDimred$iso1)
iso1_onlyDimred %>%  filter(iso1>(summary_iso1[5]+summary_iso1[6])/2)-> iso1_onlyDimred_candidates
iso1_onlyDimred_candidates
iso1allcors %>% filter(is.na(iso1_all)) ->iso1_notinDimred
iso1_notinDimred  %>% ggplot(aes(iso1))+geom_histogram(bins = 100)
summary_notindimred_iso1<-summary(iso1_notinDimred$iso1)
iso1_notinDimred %>%  filter(iso1>(summary_notindimred_iso1[5]+summary_notindimred_iso1[6])/2)-> iso1_notinDimred_candidates
```

## iso 2
```{r}
iso2allcors<-fread("../results/corrTable/05_CorrTable_iso2_quantiles_shapleys_2019to2021_all.csv")
iso2allcors %>% filter(!is.na(iso2_all)) ->iso2_onlyDimred
iso2_onlyDimred  %>%  ggplot(aes(iso2_all))+geom_histogram(bins = 100)
iso2_onlyDimred  %>% ggplot(aes(iso2_shapley))+geom_histogram(bins = 100)
summary_iso2<-summary(iso2_onlyDimred$iso2_shapley)
iso2_onlyDimred %>%  filter(iso2_shapley>(summary_iso2[5]+summary_iso2[6])/2)-> iso2_onlyDimred_candidates

iso2allcors %>% filter(is.na(iso2_all)) ->iso2_notinDimred
iso2_notinDimred  %>% ggplot(aes(iso2_shapley))+geom_histogram(bins = 100)
summary_notindimred_iso2<-summary(iso2_notinDimred$iso2_shapley)
iso2_notinDimred %>%  filter(iso2_shapley>(summary_notindimred_iso2[5]+summary_notindimred_iso2[6])/2)-> iso2_notinDimred_candidates
```

## iso 3
```{r}
iso3allcors<-fread("../results/corrTable/04_CorrTable_iso3_quantiles_shapleys_2019to2021_all.csv")

iso3allcors %>% filter(!is.na(iso1_all)) ->iso3_onlyDimred

iso3_onlyDimred  %>%  ggplot(aes(iso1_all))+geom_histogram(bins = 100)
iso3_onlyDimred  %>% ggplot(aes(iso3_shapley))+geom_histogram(bins = 100)
summary_iso3<-summary(iso3_onlyDimred$iso3_shapley)
iso3_onlyDimred %>%  filter(iso3_shapley>(summary_iso3[5]+summary_iso3[6])/2)-> iso3_onlyDimred_candidates

iso3allcors %>% filter(is.na(iso3_all)) ->iso3_notinDimred
iso3_notinDimred  %>% ggplot(aes(iso3_shapley))+geom_histogram(bins = 100)
summary_notindimred_iso3<-summary(iso3_notinDimred$iso3_shapley)
iso3_notinDimred %>%  filter(iso3_shapley>(summary_notindimred_iso3[5]+summary_notindimred_iso3[6])/2)-> iso3_notinDimred_candidates
```

## iso 4
```{r}
iso4allcors<-fread("../results/corrTable/04_CorrTable_iso4_quantiles_shapley_2019to2021_all.csv")
iso4allcors %>% filter(!is.na(iso4_all)) ->iso4_onlyDimred
iso4_onlyDimred  %>%  ggplot(aes(iso4_all))+geom_histogram(bins = 100)
iso4_onlyDimred  %>% ggplot(aes(iso4_shapley))+geom_histogram(bins = 100)
summary_iso4<-summary(iso4_onlyDimred$iso4_shapley)
iso4_onlyDimred %>%  filter(iso4_shapley>(summary_iso4[5]))-> iso4_onlyDimred_candidates

iso4allcors %>% filter(is.na(iso4_all)) ->iso4_notinDimred
iso4_notinDimred  %>% ggplot(aes(iso4_shapley))+geom_histogram(bins = 100)
summary_notindimred_iso4<-summary(iso4_notinDimred$iso4_shapley)
iso4_notinDimred %>%  filter(iso4_shapley>(summary_notindimred_iso4[5]+summary_notindimred_iso4[6])/2)-> iso4_notinDimred_candidates
```

## iso 5
```{r}
iso5allcors<-fread("../results/corrTable/04_CorrTable_iso5_quantiles_shapley_2019to2021_all.csv")
iso5allcors %>% filter(!is.na(iso5_all)) ->iso5_onlyDimred
iso5_onlyDimred  %>%  ggplot(aes(iso5_all))+geom_histogram(bins = 100)
iso5_onlyDimred  %>% ggplot(aes(iso5_shapley))+geom_histogram(bins = 100)
summary_iso5<-summary(iso5_onlyDimred$iso5_shapley)
iso5_onlyDimred %>%  filter(iso5>(summary_iso5[5]+summary_iso5[6])/2)-> iso5_onlyDimred_candidates

iso5allcors %>% filter(is.na(iso5_all)) ->iso5_notinDimred
iso5_notinDimred  %>% ggplot(aes(iso5))+geom_histogram(bins = 100)
summary_notindimred_iso5<-summary(iso5_notinDimred$iso5)
iso5_notinDimred %>%  filter(iso5>(summary_notindimred_iso5[5]+summary_notindimred_iso5[6])/2)-> iso5_notinDimred_candidates
```

## iso 6
```{r}
iso6allcors<-fread("../results/corrTable/04_CorrTable_iso6_quantiles_shapley_2019to2021_all.csv")
iso6allcors %>% filter(!is.na(iso6_all)) ->iso6_onlyDimred
iso6_onlyDimred  %>%  ggplot(aes(iso6_all))+geom_histogram(bins = 100)
iso6_onlyDimred  %>% ggplot(aes(iso6_shapley))+geom_histogram(bins = 100)
summary_iso6<-summary(iso6_onlyDimred$iso6_shapley)
iso6_onlyDimred %>%  filter(iso6_shapley>(summary_iso6[5]+summary_iso6[6])/2)-> iso6_onlyDimred_candidates

iso6allcors %>% filter(is.na(iso6_all)) ->iso6_notinDimred
iso6_notinDimred  %>% ggplot(aes(iso6_shapley))+geom_histogram(bins = 100)
summary_notindimred_iso6<-summary(iso6_notinDimred$iso6_shapley)
iso6_notinDimred %>%  filter(iso6_shapley>(summary_notindimred_iso6[5]+summary_notindimred_iso6[6])/2)-> iso6_notinDimred_candidates
```

## iso 7
```{r}
iso7allcors<-fread("../results/corrTable/04_CorrTable_iso7_quantiles_shapley_2019to2021_all.csv")
iso7allcors %>% filter(!is.na(iso7_all)) ->iso7_onlyDimred
iso7_onlyDimred  %>%  ggplot(aes(iso7_shapley))+geom_histogram(bins = 100)
iso7_onlyDimred  %>% ggplot(aes(iso7_shapley))+geom_histogram(bins = 100)
summary_iso7<-summary(iso7_onlyDimred$iso7_shapley)
iso7_onlyDimred %>%  filter(iso7_shapley>(summary_iso7[5]+summary_iso7[6])/2)-> iso7_onlyDimred_candidates

iso7allcors %>% filter(is.na(iso7_all)) ->iso7_notinDimred
iso7_notinDimred  %>% ggplot(aes(iso7_shapley))+geom_histogram(bins = 100)
summary_notindimred_iso7<-summary(iso7_notinDimred$iso7_shapley)
iso7_notinDimred %>%  filter(iso7_shapley>(summary_notindimred_iso7[5]+summary_notindimred_iso7[6])/2)-> iso7_notinDimred_candidates
```


## merge
### onlydimred
```{r}

iso1_onlyDimred %>%  
  mutate(EnergyCorr=iso1,
         PearsonCorr=Pearson_iso1,
         N=N,
         Range=range,
         Iso="iso1") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(N>20) %>% filter(EnergyCorr>summary_iso1[5])-> iso1_onlyDimred_SET


iso2_onlyDimred %>%  
  mutate(EnergyCorr=iso2_shapley,
         PearsonCorr=Pearson_iso2_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso2") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso2[5])-> iso2_onlyDimred_SET

iso3_onlyDimred %>%  
  mutate(EnergyCorr=iso3_shapley,
         PearsonCorr=Pearson_iso3_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso3") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso3[5])-> iso3_onlyDimred_SET

iso4_onlyDimred %>%  
  mutate(EnergyCorr=iso4_shapley,
         PearsonCorr=Pearson_iso4_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso4") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso4[5])-> iso4_onlyDimred_SET

iso5_onlyDimred %>%  
  mutate(EnergyCorr=iso5_shapley,
         PearsonCorr=Pearson_iso5_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso5") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso5[5])-> iso5_onlyDimred_SET


iso6_onlyDimred %>%  
  mutate(EnergyCorr=iso6_shapley,
         PearsonCorr=Pearson_iso6_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso6") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso6[5])-> iso6_onlyDimred_SET

iso7_onlyDimred %>%  
  mutate(EnergyCorr=iso7_shapley,
         PearsonCorr=Pearson_iso7_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso7") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso7[5])-> iso7_onlyDimred_SET


highestCorrelations_onlyDimred_Set<-rbind(iso1_onlyDimred_SET,iso2_onlyDimred_SET,iso3_onlyDimred_SET,iso4_onlyDimred_SET,iso5_onlyDimred_SET,iso6_onlyDimred_SET,iso7_onlyDimred_SET)
```

### not in dimred
```{r}
iso1_notinDimred %>%  
  mutate(EnergyCorr=iso1,
         PearsonCorr=Pearson_iso1,
         N=N,
         Range=range,
         Iso="iso1") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso1[5])-> iso1_notinDimred_SET

iso2_notinDimred %>%  
  mutate(EnergyCorr=iso2_shapley,
         PearsonCorr=Pearson_iso2_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso2") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso2[5])-> iso2_notinDimred_SET

iso3_notinDimred %>%  
  mutate(EnergyCorr=iso3_shapley,
         PearsonCorr=Pearson_iso3_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso3") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso3[5])-> iso3_notinDimred_SET

iso4_notinDimred %>%  
  mutate(EnergyCorr=iso4_shapley,
         PearsonCorr=Pearson_iso4_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso4") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso4[5])-> iso4_notinDimred_SET

iso6_notinDimred %>%  
  mutate(EnergyCorr=iso6_shapley,
         PearsonCorr=Pearson_iso6_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso6") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso6[5])-> iso6_notinDimred_SET

iso7_notinDimred %>%  
  mutate(EnergyCorr=iso7_shapley,
         PearsonCorr=Pearson_iso7_shapley,
         N=N_shapley,
         Range=range_shapley,
         Iso="iso7") %>% 
  select("Series Code","Topic","Indicator Name","EnergyCorr","PearsonCorr","N","Range","Iso") %>% arrange(desc(EnergyCorr)) %>% filter(EnergyCorr>summary_iso7[5])-> iso7_notinDimred_SET


highestCorrelations_notinDimred_Set<-rbind(iso1_notinDimred_SET,iso2_notinDimred_SET,iso3_notinDimred_SET,iso4_notinDimred_SET,iso6_notinDimred_SET,iso7_notinDimred_SET)
```

# 3 Circle plot
`
## all data
```{r}
DATA_DIR<-"../data/"
RELATIVE_INDICATORS_FILE_NAME <- "../data/01_data/relative_indicators_2023_06.R"

order_indidactors<-iso1_onlyDimred$`Series Code` 
dcor_var_iso_cons<-matrix(nrow =length(order_indidactors),ncol=7)
rownames(dcor_var_iso_cons)<-order_indidactors
dcor_var_iso_cons[,1]<-iso1_onlyDimred[iso1_onlyDimred$`Series Code`%in% order_indidactors,"iso1_all"] %>%  unlist
dcor_var_iso_cons[,2]<-iso2_onlyDimred[iso2_onlyDimred$`Series Code`%in% order_indidactors,"iso2_all"] %>%  unlist
dcor_var_iso_cons[,3]<-iso3_onlyDimred[iso3_onlyDimred$`Series Code`%in% order_indidactors,"iso3_all"] %>%  unlist
dcor_var_iso_cons[,4]<-iso4_onlyDimred[iso4_onlyDimred$`Series Code`%in% order_indidactors,"iso4_all"] %>%  unlist
dcor_var_iso_cons[,5]<-iso5_onlyDimred[iso5_onlyDimred$`Series Code`%in% order_indidactors,"iso5_all"] %>%  unlist
dcor_var_iso_cons[,6]<-iso6_onlyDimred[iso6_onlyDimred$`Series Code`%in% order_indidactors,"iso6_all"] %>%  unlist
dcor_var_iso_cons[,7]<-iso7_onlyDimred[iso7_onlyDimred$`Series Code`%in% order_indidactors,"iso7_all"] %>%  unlist


used_var_names_max_dcor <- c(
  dcor_var_iso_cons[, 1] %>% order(decreasing = TRUE) %>% { .[1:15] } %>% { names(dcor_var_iso_cons[., 1]) },
  dcor_var_iso_cons[, 2] %>% order(decreasing = TRUE) %>% { .[1:15] } %>% { names(dcor_var_iso_cons[., 2]) },
  dcor_var_iso_cons[, 3] %>% order(decreasing = TRUE) %>% { .[1:30] } %>% { names(dcor_var_iso_cons[., 3]) },
  dcor_var_iso_cons[, 4] %>% order(decreasing = TRUE) %>% { .[1:30] } %>% { names(dcor_var_iso_cons[., 4]) },
  dcor_var_iso_cons[, 5] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 5]) },
  dcor_var_iso_cons[, 6] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 6]) },
  dcor_var_iso_cons[, 7] %>% order(decreasing = TRUE) %>% { .[1:10]  } %>% {names(dcor_var_iso_cons[., 7]) }
) %>% unique %>% sort
subsetwdi<-wdi_explained[wdi_explained$`Series Code`%in% used_var_names_max_dcor,]

```

#### input
```{r}
source("../libraries/01a_lib_social_indicators.R")
DATA_DIR<-"../data/"
RELATIVE_INDICATORS_FILE_NAME <- "../data/01_data/relative_indicators_2023_06.R"
var_names         = used_var_names_max_dcor
dcor_var_iso_cons = dcor_var_iso_cons
load("../data/wdi_series")
local_wdi_series  = wdi_series[,]



```

#### setup
```{r}




subsetwdi<-wdi_explained[wdi_explained$`Series Code`%in% used_var_names_max_dcor,]

var_names         = used_var_names_max_dcor
dcor_var_iso_cons = dcor_var_iso_cons
load("../data/wdi_series")
local_wdi_series  = wdi_series[,]
expand_multiplier = 1 / 10
text_size         = 5
label_modifier    = manual_label_modifier
col_pal <- c("#1F968B", "#3CBB75", "#7570b3", "#e7298a", "yellow3", "orange","slategrey")
```

### plot function
```{r}

#label_modifier    = short_name_label_modifier,
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 15
.height = 15

component_common <- "Dimension"
component_names <- paste(component_common, 1:7)
xy_expand <- function(xy, expand) xy * (1 + expand * expand_multiplier)
# Does not work
local_wdi_series<-local_wdi_series[grepl(":",local_wdi_series$Topic),]

local_wdi_series <- wdi_series_split_topic(local_wdi_series)

wdi_series_used_important <- local_wdi_series[`Indicator Code` %in% var_names]
var_names<-var_names[var_names%in% wdi_series_used_important$`Indicator Code`]
require(igraph)
stopifnot(length(var_names) == nrow(wdi_series_used_important))
dcor_var_iso_cons_subset<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]
dcor_var_iso_cons<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]



local_wdi_series<-local_wdi_series[local_wdi_series$`Indicator Code`%in% var_names,]
require(tidygraph)
require(ggraph)

dcor_subset<-dcor_var_iso_cons_subset
## local_wdi_series$`Indicator Code`
edges_level_01 <- local_wdi_series %>% select(`Indicator Code`, Topic1) %>%
  unique %>% rename( from = Topic1, to = `Indicator Code`)
edges_level_12 <- local_wdi_series %>% select(Topic1, Topic2)           %>%
  unique %>% rename( from = Topic2, to = Topic1          )
edges_level_23 <- local_wdi_series %>% select(Topic2, Topic3)           %>%
  unique %>% rename( from = Topic3, to = Topic2          )
edges_level_34 <- local_wdi_series %>% select(Topic3, Topic4)           %>%
  unique %>% rename( from = Topic4, to = Topic3          )
edges_level_45 <- local_wdi_series %>% select(Topic4, Topic5)           %>%
  unique %>% rename( from = Topic5, to = Topic4          )
## create the actual igraph object

rbind(edges_level_01, edges_level_12, edges_level_23, edges_level_34,
      edges_level_45) %>%
unique %>%
filter(to != from) ->listi
hier_graph <-listi %>% data.frame() %>%  { .[rev(seq_len(ncol(.)))] } %>% graph_from_data_frame
  ## graph_from_data_frame does not care about column names,
  ## only about positions
  # %>%
  #graph_from_data_frame

## additional data:

graph_idxs <- match(var_names, V(hier_graph)$name)

hier_graph <- set_vertex_attr(hier_graph, "which_max_iso", graph_idxs,
                              dcor_subset %>% apply(1, which.max))
hier_graph <- set_vertex_attr(hier_graph, "dcor_max", graph_idxs,
                              dcor_subset %>% apply(1, max))
hier_graph <- set_vertex_attr(hier_graph, "dcor1", graph_idxs,
                              dcor_subset[, 1])
hier_graph <- set_vertex_attr(hier_graph, "dcor2", graph_idxs,
                              dcor_subset[, 2])
hier_graph <- set_vertex_attr(hier_graph, "dcor3", graph_idxs,
                              dcor_subset[, 3])
hier_graph <- set_vertex_attr(hier_graph, "dcor4", graph_idxs,
                              dcor_subset[, 4])
hier_graph <- set_vertex_attr(hier_graph, "dcor5", graph_idxs,
                              dcor_subset[, 5])
hier_graph <- set_vertex_attr(hier_graph, "dcor6", graph_idxs,
                              dcor_subset[, 6])
hier_graph <- set_vertex_attr(hier_graph, "dcor7", graph_idxs,
                              dcor_subset[, 7])
# 

hier_graph <-
  set_vertex_attr(hier_graph, "Indicator.Code", graph_idxs,
                  local_wdi_series$`Indicator Code`[
                               match(var_names, local_wdi_series$`Indicator Code`)])



# thisPeople<-fread("../data/indicator_compressed_names.csv")
# wdi_names_prepared<-wdi_series_used_important[,c("Indicator Code","Indicator Name")]
# 
# 
# merge(wdi_names_prepared,thisPeople,by="Indicator Code",all.x = T)->wdi_names_prepared2

# wdi_names_prepared2 %>% select(`Indicator Code`,`Indicator Name`,`Compressed Name`)%>%  filter(is.na(`Compressed Name`)) %>% fwrite("../output/preparethenameschatgpt.csv")
# 
# wdi_series_used[,c("Indicator Code","Compressed Name")] #%>% fwrite("../data/indicator_compressed_names.csv")
# # # chatgpt shortened the names
# wdi_series_used
# wdi_series_used2<-fread("../data/indicator_compressed_names.csv")
# shortnames<-fread("../data/05_abbrevationmaker.csv",sep=";")
# rbind(wdi_series_used2[!(wdi_series_used2$`Indicator Code`%in% shortnames$`Indicator Code`)],shortnames) %>%  fwrite("../output/05_indicator_compressed_names.csv")

wdi_series_used<-fread("../data/indicator_compressed_names.csv")

wdi_var_hierarchy_graph <-hier_graph
axis_cons <- lapply(1:7, inner_connections_by_axis,
                       dcor_var_iso_cons       = dcor_var_iso_cons,
                       wdi_var_hierarchy_graph = wdi_var_hierarchy_graph,
                       var_names               = var_names)




expand_multiplier = 1/2
text_size         = 3
label_modifier    = manual_label_modifier
#label_modifier    = short_name_label_modifier
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 50
.height = 50


wdi_var_hierarchy_graph %>%
ggraph(layout = "dendrogram", circular = TRUE) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor1),
                    y = xy_expand(y, dcor1)),
                colour = col_pal[1]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor1),
                 y = xy_expand(y, dcor1)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[1]) +
geom_node_point(aes(filter = leaf,
                   x = xy_expand(x, dcor2),
                    y = xy_expand(y, dcor2)),
                colour = col_pal[2]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor2),
                 y = xy_expand(y, dcor2)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[2]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor3),
                    y = xy_expand(y, dcor3)),
                colour = col_pal[3]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor3),
                 y = xy_expand(y, dcor3)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[3]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor4),
                    y = xy_expand(y, dcor4)),
                colour = col_pal[4]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor4),
                 y = xy_expand(y, dcor4)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[4]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[6]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[6]) +
      geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[7]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[7]) +
geom_node_point(aes(filter = leaf, color = factor(which_max_iso)),
                size = 0)+
geom_node_text(aes(filter = leaf,
                   label  = label_modifier(as.character(Indicator.Code)),
                   color  = factor(paste(component_common, which_max_iso)),
                   x      = x * (1 + 1 * expand_multiplier),
                   y      = y * (1 + 1 * expand_multiplier),
                   hjust  = if_else(x > 0, 0, 1),
                   angle  = atan(y / x) / 2 / pi * 360),
               show.legend = FALSE,
               size        = text_size) +
geom_conn_bundle(data = get_con(axis_cons[[1]][1, ], axis_cons[[1]][2, ]),
                 edge_colour = col_pal[1], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[2]][1, ], axis_cons[[2]][2, ]),
                 edge_colour = col_pal[2], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[3]][1, ], axis_cons[[3]][2, ]),
                 edge_colour = col_pal[3], edge_alpha = 0.3) +
(
  if (ncol(axis_cons[[4]]) > 0)
    geom_conn_bundle(data = get_con(axis_cons[[4]][1, ],
                                    axis_cons[[4]][2, ]),
                     edge_colour = col_pal[4], edge_alpha = 0.3)
  else
    list()
) +
geom_conn_bundle(data = get_con(axis_cons[[5]][1, ], axis_cons[[5]][2, ]),
                 edge_colour = col_pal[5], edge_alpha = 0.3) +
geom_edge_diagonal() +
# geom_node_label(aes(filter = !leaf,
#                     fontface = if_else(name %in% level1, "bold", "plain"),
#                     label = name, angle = atan(y / x) / 2 / pi * 360),
#                 size = 2) +
scale_color_manual(limits = component_names,
                   labels = component_names,
                   values = col_pal) +
guides(colour = guide_legend(title = component_common,
                             override.aes = list(size = 5))) +
theme_void() +
theme(legend.title = element_blank(),
      legend.position = c(0.9, 0.1),
      legend.justification = c(0.9, 0.1)) +
expand_limits(x = c(-2.7, 2.7), y = c(-2.7, 2.7))
# 
ggsave("../figures/05_230711_circle_all_test.pdf",device = "pdf",height = 12,width = 12)

```
## Significant shapleys


### input
#### data

```{r}
DATA_DIR<-"../data/"
RELATIVE_INDICATORS_FILE_NAME <- "../data/01_data/relative_indicators_2023_06.R"

order_indidactors<-iso1_onlyDimred$`Series Code` 
dcor_var_iso_cons<-matrix(nrow =length(order_indidactors),ncol=7)
rownames(dcor_var_iso_cons)<-order_indidactors
dcor_var_iso_cons[,1]<-iso1_onlyDimred[iso1_onlyDimred$`Series Code`%in% order_indidactors,"iso1"] %>%  unlist
dcor_var_iso_cons[,2]<-iso2_onlyDimred[iso2_onlyDimred$`Series Code`%in% order_indidactors,"iso2_75to100_75to100"] %>%  unlist
dcor_var_iso_cons[,3]<-iso3_onlyDimred[iso3_onlyDimred$`Series Code`%in% order_indidactors,"iso3_shapley"] %>%  unlist
dcor_var_iso_cons[,4]<-iso4_onlyDimred[iso4_onlyDimred$`Series Code`%in% order_indidactors,"iso4_shapley"] %>%  unlist
dcor_var_iso_cons[,5]<-iso5_onlyDimred[iso5_onlyDimred$`Series Code`%in% order_indidactors,"iso5_shapley"] %>%  unlist
dcor_var_iso_cons[,6]<-iso6_onlyDimred[iso6_onlyDimred$`Series Code`%in% order_indidactors,"iso6_shapley"] %>%  unlist
dcor_var_iso_cons[,7]<-iso7_onlyDimred[iso7_onlyDimred$`Series Code`%in% order_indidactors,"iso7_shapley"] %>%  unlist
```

#### setup
```{r}


used_var_names_max_dcor <- c(
  dcor_var_iso_cons[, 1] %>% order(decreasing = TRUE) %>% { .[1:10] } %>% { names(dcor_var_iso_cons[., 1]) },
  dcor_var_iso_cons[, 2] %>% order(decreasing = TRUE) %>% { .[1:10] } %>% { names(dcor_var_iso_cons[., 2]) },
  dcor_var_iso_cons[, 3] %>% order(decreasing = TRUE) %>% { .[1:50] } %>% { names(dcor_var_iso_cons[., 3]) },
  dcor_var_iso_cons[, 4] %>% order(decreasing = TRUE) %>% { .[1:50] } %>% { names(dcor_var_iso_cons[., 4]) },
  dcor_var_iso_cons[, 5] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 5]) },
  dcor_var_iso_cons[, 6] %>% order(decreasing = TRUE) %>% { .[1:05] } %>% { names(dcor_var_iso_cons[., 6]) },
  dcor_var_iso_cons[, 7] %>% order(decreasing = TRUE) %>% { .[1:15]  } %>% {names(dcor_var_iso_cons[., 7]) }
) %>% unique %>% sort

subsetwdi<-wdi_explained[wdi_explained$`Series Code`%in% used_var_names_max_dcor,]

var_names         = used_var_names_max_dcor
dcor_var_iso_cons = dcor_var_iso_cons
load("../data/wdi_series")
local_wdi_series  = wdi_series[,]
expand_multiplier = 1 / 10
text_size         = 5
label_modifier    = manual_label_modifier
col_pal <- c("#1F968B", "#3CBB75", "#7570b3", "#e7298a", "yellow3", "orange","slategrey")
```

#### modifiy the compressed names
```{r}
compressedNames <- fread("../data/indicator_compressed_names.csv")

missingIndicators <- wdi_explained %>%
  filter(`Series Code` %in% used_var_names_max_dcor) %>%
  select(`Series Code`,`Indicator Name`) %>%
  rename(`Indicator Code` = `Series Code`) %>%
  merge(compressedNames[,c("Indicator Code","Compressed Name")], by = "Indicator Code", all.x = TRUE) %>%
  filter(is.na(`Compressed Name`))

missingIndicators

# 
#missingIndicators %>% fwrite("../data/05_abbrevationmaker.csv",sep=";")

#rbind(compressedNames,addthis) %>% fwrite("../data/indicator_compressed_names.csv")
```



### plot function
```{r}

#label_modifier    = short_name_label_modifier,
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 15
.height = 15

component_common <- "Dimension"
component_names <- paste(component_common, 1:7)
xy_expand <- function(xy, expand) xy * (1 + expand * expand_multiplier)
# Does not work
local_wdi_series<-local_wdi_series[grepl(":",local_wdi_series$Topic),]

local_wdi_series <- wdi_series_split_topic(local_wdi_series)

wdi_series_used_important <- local_wdi_series[`Indicator Code` %in% var_names]
var_names<-var_names[var_names%in% wdi_series_used_important$`Indicator Code`]
require(igraph)
stopifnot(length(var_names) == nrow(wdi_series_used_important))
dcor_var_iso_cons_subset<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]
dcor_var_iso_cons<-dcor_var_iso_cons[rownames(dcor_var_iso_cons)%in% var_names,]



local_wdi_series<-local_wdi_series[local_wdi_series$`Indicator Code`%in% var_names,]
require(tidygraph)
require(ggraph)

dcor_subset<-dcor_var_iso_cons_subset
## local_wdi_series$`Indicator Code`
edges_level_01 <- local_wdi_series %>% select(`Indicator Code`, Topic1) %>%
  unique %>% rename( from = Topic1, to = `Indicator Code`)
edges_level_12 <- local_wdi_series %>% select(Topic1, Topic2)           %>%
  unique %>% rename( from = Topic2, to = Topic1          )
edges_level_23 <- local_wdi_series %>% select(Topic2, Topic3)           %>%
  unique %>% rename( from = Topic3, to = Topic2          )
edges_level_34 <- local_wdi_series %>% select(Topic3, Topic4)           %>%
  unique %>% rename( from = Topic4, to = Topic3          )
edges_level_45 <- local_wdi_series %>% select(Topic4, Topic5)           %>%
  unique %>% rename( from = Topic5, to = Topic4          )
## create the actual igraph object

rbind(edges_level_01, edges_level_12, edges_level_23, edges_level_34,
      edges_level_45) %>%
unique %>%
filter(to != from) ->listi
hier_graph <-listi %>% data.frame() %>%  { .[rev(seq_len(ncol(.)))] } %>% graph_from_data_frame
  ## graph_from_data_frame does not care about column names,
  ## only about positions
  # %>%
  #graph_from_data_frame

## additional data:

graph_idxs <- match(var_names, V(hier_graph)$name)

hier_graph <- set_vertex_attr(hier_graph, "which_max_iso", graph_idxs,
                              dcor_subset %>% apply(1, which.max))
hier_graph <- set_vertex_attr(hier_graph, "dcor_max", graph_idxs,
                              dcor_subset %>% apply(1, max))
hier_graph <- set_vertex_attr(hier_graph, "dcor1", graph_idxs,
                              dcor_subset[, 1])
hier_graph <- set_vertex_attr(hier_graph, "dcor2", graph_idxs,
                              dcor_subset[, 2])
hier_graph <- set_vertex_attr(hier_graph, "dcor3", graph_idxs,
                              dcor_subset[, 3])
hier_graph <- set_vertex_attr(hier_graph, "dcor4", graph_idxs,
                              dcor_subset[, 4])
hier_graph <- set_vertex_attr(hier_graph, "dcor5", graph_idxs,
                              dcor_subset[, 5])
hier_graph <- set_vertex_attr(hier_graph, "dcor6", graph_idxs,
                              dcor_subset[, 6])
hier_graph <- set_vertex_attr(hier_graph, "dcor7", graph_idxs,
                              dcor_subset[, 7])
# 

hier_graph <-
  set_vertex_attr(hier_graph, "Indicator.Code", graph_idxs,
                  local_wdi_series$`Indicator Code`[
                               match(var_names, local_wdi_series$`Indicator Code`)])



# thisPeople<-fread("../data/indicator_compressed_names.csv")
# wdi_names_prepared<-wdi_series_used_important[,c("Indicator Code","Indicator Name")]
# 
# 
# merge(wdi_names_prepared,thisPeople,by="Indicator Code",all.x = T)->wdi_names_prepared2

# wdi_names_prepared2 %>% select(`Indicator Code`,`Indicator Name`,`Compressed Name`)%>%  filter(is.na(`Compressed Name`)) %>% fwrite("../output/preparethenameschatgpt.csv")
# 
# wdi_series_used[,c("Indicator Code","Compressed Name")] #%>% fwrite("../data/indicator_compressed_names.csv")
# # # chatgpt shortened the names
# wdi_series_used
# wdi_series_used2<-fread("../data/indicator_compressed_names.csv")
# shortnames<-fread("../data/05_abbrevationmaker.csv",sep=";")
# rbind(wdi_series_used2[!(wdi_series_used2$`Indicator Code`%in% shortnames$`Indicator Code`)],shortnames) %>%  fwrite("../output/05_indicator_compressed_names.csv")

wdi_series_used<-fread("../data/indicator_compressed_names.csv")

wdi_var_hierarchy_graph <-hier_graph
axis_cons <- lapply(1:7, inner_connections_by_axis,
                       dcor_var_iso_cons       = dcor_var_iso_cons,
                       wdi_var_hierarchy_graph = wdi_var_hierarchy_graph,
                       var_names               = var_names)




expand_multiplier = 1/2
text_size         = 3
label_modifier    = manual_label_modifier
#label_modifier    = short_name_label_modifier
## .overwrite = TRUE, # nolint: commented_code_linter.
.width  = 50
.height = 50


wdi_var_hierarchy_graph %>%
ggraph(layout = "dendrogram", circular = TRUE) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor1),
                    y = xy_expand(y, dcor1)),
                colour = col_pal[1]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor1),
                 y = xy_expand(y, dcor1)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[1]) +
geom_node_point(aes(filter = leaf,
                   x = xy_expand(x, dcor2),
                    y = xy_expand(y, dcor2)),
                colour = col_pal[2]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor2),
                 y = xy_expand(y, dcor2)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[2]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor3),
                    y = xy_expand(y, dcor3)),
                colour = col_pal[3]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor3),
                 y = xy_expand(y, dcor3)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[3]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor4),
                    y = xy_expand(y, dcor4)),
                colour = col_pal[4]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor4),
                 y = xy_expand(y, dcor4)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[4]) +
geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[5]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[5]) +
  geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[6]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[6]) +
      geom_node_point(aes(filter = leaf,
                    x = xy_expand(x, dcor5),
                    y = xy_expand(y, dcor5)),
                colour = col_pal[7]) +
geom_polygon(aes(sort = name,
                 filter = name %in% var_names,
                 x = xy_expand(x, dcor5),
                 y = xy_expand(y, dcor5)),
             stat = stat_filter_sort,
             group = 1,
             fill = NA,
             colour = col_pal[7]) +
geom_node_point(aes(filter = leaf, color = factor(which_max_iso)),
                size = 0)+
geom_node_text(aes(filter = leaf,
                   label  = label_modifier(as.character(Indicator.Code)),
                   color  = factor(paste(component_common, which_max_iso)),
                   x      = x * (1 + 1 * expand_multiplier),
                   y      = y * (1 + 1 * expand_multiplier),
                   hjust  = if_else(x > 0, 0, 1),
                   angle  = atan(y / x) / 2 / pi * 360),
               show.legend = FALSE,
               size        = text_size) +
geom_conn_bundle(data = get_con(axis_cons[[1]][1, ], axis_cons[[1]][2, ]),
                 edge_colour = col_pal[1], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[2]][1, ], axis_cons[[2]][2, ]),
                 edge_colour = col_pal[2], edge_alpha = 0.3) +
geom_conn_bundle(data = get_con(axis_cons[[3]][1, ], axis_cons[[3]][2, ]),
                 edge_colour = col_pal[3], edge_alpha = 0.3) +
(
  if (ncol(axis_cons[[4]]) > 0)
    geom_conn_bundle(data = get_con(axis_cons[[4]][1, ],
                                    axis_cons[[4]][2, ]),
                     edge_colour = col_pal[4], edge_alpha = 0.3)
  else
    list()
) +
geom_conn_bundle(data = get_con(axis_cons[[5]][1, ], axis_cons[[5]][2, ]),
                 edge_colour = col_pal[5], edge_alpha = 0.3) +
geom_edge_diagonal() +
# geom_node_label(aes(filter = !leaf,
#                     fontface = if_else(name %in% level1, "bold", "plain"),
#                     label = name, angle = atan(y / x) / 2 / pi * 360),
#                 size = 2) +
scale_color_manual(limits = component_names,
                   labels = component_names,
                   values = col_pal) +
guides(colour = guide_legend(title = component_common,
                             override.aes = list(size = 5))) +
theme_void() +
theme(legend.title = element_blank(),
      legend.position = c(0.9, 0.1),
      legend.justification = c(0.9, 0.1)) +
expand_limits(x = c(-2.7, 2.7), y = c(-2.7, 2.7))

ggsave("../figures/05_230711_circle_test2.pdf",device = "pdf",height = 12,width = 12)

```



