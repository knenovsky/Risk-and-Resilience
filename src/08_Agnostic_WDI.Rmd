---
title: "08_Agnostic_WDI"
author: "Kolja Nenoff"
date: "2023-08-14"
output: html_document
---
# 0 data
```{r setup, include=FALSE}
# rm(list = ls())
require(ggcorrplot)
library(rstudioapi)
library(magrittr)
library(tidyverse)
library(data.table)
library(parallel)
library(dimRed)
library(devtools)
library(igraph)
library(energy)
library(ggrepel)
library(ggalt)
library(ggraph)
library(trend)
library(riverplot)
library(RANN)
library(RJSONIO)
library(RSpectra)
library(pcaMethods)
require(broom)
require(GGally)
require(ggpubr)
require(xgboost)
require(caret)
require(pdp)
require(iml)
require(data.table)
require(tidyverse)
require(cowplot)
require(readxl)

wdi_explained<-fread("../data/WDI_data_230609/WDI_CSV/WDISeries.csv")
#load("../data/07_230504_OWID_dataset")
wdi_data<-fread("../data/05_WDI_data.csv")
dimred2021_knn250_2<-fread("../output/02_230612_Dimred_ExcessMort_annual.csv")
col_pal <- c("#1F968B",  "#7570b3", "#e7298a", "#3CBB75","yellow3", "orange","slategrey")

source("00_toolbox.R")
```


# 1 Tracing back the DImred XGboost for WDI and Dimred


## get indicator info
```{r}


dimred2021_knn250_2$pscore_level<-as.factor(ntile(dimred2021_knn250_2$pscore_mean, 4))
dimred2021_knn250_2 %>% group_by(pscore_level) %>% summarize(Min=min(pscore_mean),Max=max(pscore_mean)) %>% mutate(p_score_level_label=paste0(Min," to ",Max)) %>% 
  left_join(dimred2021_knn250_2, . ,by="pscore_level")-> dimred2021_knn250_3
dimred2021_knn250_3 %>% 
  # mutate(pscore_cat2 = fct_relevel(pscore_cat, 
  #           "", "<0", "0 to <5","5 to <10","10 to <20","20 to <30","30 to <40","40 to <50", ">=50" )) %>% 
  mutate(p_score_level_label = fct_relevel(p_score_level_label,
            "-6.4 to 5.5" , "5.5 to 8.6" , "8.6 to 18.1" ,"18.1 to 97.1"  )) %>%
  mutate(p_score_level_label2=case_when(p_score_level_label%in% "18.1 to 97.1" & RegionSoviet %in% "Post-Soviet"~"High Soviets",
                                            p_score_level_label%in% "18.1 to 97.1" & RegionSoviet %in% "Latin America & Caribbean"~"High Latin",
                                               p_score_level_label%in% "18.1 to 97.1" ~"High other",
                                              TRUE~p_score_level_label ))    %>%                                                                                     
  # mutate(p_score_level_label = fct_relevel(p_score_level_label, 
  #           "-6.4 to 4.4","4.4 to 7" ,  "7 to 11.6" ,"11.6 to 20.1" ,"20.1 to 97.1" )) %>% 

  filter(!is.na(pscore_level))->dimred2021_knn250_3 


add_col<-c(colnames(wdi_data)[!(colnames(wdi_data)%in% colnames(dimred2021_knn250_3))])



wdi_data %>% mutate(identifier=paste0(`Country Code`,year)) %>%select(any_of(c("Country Code","year","identifier",add_col)))-> wdi_data2
dimred2021_knn250_3 %>% mutate(identifier=paste0(`Country Code`,year)) -> dimred2021_knn250_4

left_join(dimred2021_knn250_4,wdi_data2 %>% select(any_of(c("identifier",add_col))),"identifier") %>%  filter() -> dimred2021_knn250_5


fortheseIndicators<-colnames(dimred2021_knn250_5)[colnames(dimred2021_knn250_5)%in% wdi_explained$`Series Code`]
Xgboostinput2<-dimred2021_knn250_5



```


```{r}
custom_control <- trainControl(
  method = "cv",
  number = 30,  # Increase the number of folds
  search = "random",
  allowParallel = TRUE
  
)

param_grid <- expand.grid(
  nrounds = c(50,100),
  eta = c(0.05),
  max_depth = c(2, 4),
  colsample_bytree = c( 1),
  subsample = c(1),
  gamma = c(0),
  min_child_weight = c(0)
)


```

##


```{r}
filesPC<-list.files("../output/wdi_dim_corr/summarystat_pc/")
filesPC_already<-str_remove_all(filesPC,"PC_corr") %>% str_remove_all( . ,"_summary.csv")
indicator<-fortheseIndicators[!(fortheseIndicators%in% filesPC_already)]
process_indicator(indicator[1])
indicator<-indicator[!(indicator %in% "TX.VAL.TECH.CD")]
num_cores <- 1
system.time({
  clust <- makeCluster(num_cores)
  parallel::clusterExport(clust, "Xgboostinput2", envir = environment())
  parallel::clusterExport(clust, "train_xgboost_model", envir = environment())
  parallel::clusterExport(clust, "custom_control", envir = environment())
  parallel::clusterExport(clust, "param_grid", envir = environment())
  parallel::clusterExport(clust, "get_wdi_trajectory", envir = environment())
  parallel::clusterExport(clust, "dimred2021_knn250_5", envir = environment())
  parallel::clusterExport(clust, "wdi_explained", envir = environment())
  parallel::clusterExport(clust, "fortheseIndicators", envir = environment())
  a <- parLapply(clust, indicator, process_indicator)})

 #%>%  select(TX.VAL.TECH.CD) %>%  drop_na()
stopCluster(cl)
# Access the results for each indicator


```
### PCA correlation table
```{r}
filesPC<-list.files("../output/wdi_dim_corr/summarystat_pc/")
filesPC_already<-str_remove_all(filesPC,"PC_corr") %>% str_remove_all( . ,"_summary.csv")
indicator<-fortheseIndicators[(fortheseIndicators%in% filesPC_already)]


getwd()
indicator<-indicator[!(indicator %in% "TX.VAL.TECH.CD")]
num_cores <- 1


process_indicator(indicator[1])
indicator<-indicator[!(indicator %in% "TX.VAL.TECH.CD")]
num_cores <- 30
system.time({
  clust <- makeCluster(num_cores)
  parallel::clusterExport(clust, "Xgboostinput2", envir = environment())
  parallel::clusterExport(clust, "train_xgboost_model", envir = environment())
  parallel::clusterExport(clust, "custom_control", envir = environment())
  parallel::clusterExport(clust, "param_grid", envir = environment())
  parallel::clusterExport(clust, "get_wdi_trajectory", envir = environment())
  parallel::clusterExport(clust, "dimred2021_knn250_5", envir = environment())
  parallel::clusterExport(clust, "wdi_explained", envir = environment())
  parallel::clusterExport(clust, "fortheseIndicators", envir = environment())
  a <- parLapply(clust, indicator, correlation_PCA)})

 #%>%  select(TX.VAL.TECH.CD) %>%  drop_na()
stopCluster(cl)
# Access the results for
```


```{r}
# {
# PC_Corrtable %>%  drop_na()%>% fwrite(paste0("../output/wdi_dim_corr/summarystat_pc/PC_corr",Label,"_summary.csv"),)
# pdp_all2 %>% fwrite(paste0("../output/wdi_dim_corr/summarystat/",Label,"_summary.csv"),)
# shapleyplot %>% ggsave(file=paste0("../output/wdi_dim_corr/plots/",Label,"_shapley_plot.png"),device="png")
# indicatorplot %>% ggsave(file=paste0("../output/wdi_dim_corr/plots/",Label,"_indicator_plot.png"),device="png")
# }
```

## Conlusion

26 %      pc 1-5 
33 %      Iso 1 -5 
31.2 %    pc 1-14
32 %      iso   3- 7

AAAALSO es sieht so aus als 



# A: Agnost PC shapley 

```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier)))) 


dimred2021_knn250_5 %>% ggplot(aes(y=GC.XPN.COMP.ZS,x=scale(PC6))) + geom_point()+xlim(-2.5,2.5)


```


```{r}
Label<-"p_value_mort"
features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14")

#features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","new_cases_smoothed_per_million","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14")

set.seed(123)
custom_control <- trainControl(
  method = "cv",
  number = 30,  # Increase the number of folds
  search = "random",
  allowParallel = TRUE
  
)

param_grid <- expand.grid(
  nrounds = c(50,100,200),
  eta = c(0.05),
  max_depth = c(2,3, 6),
  colsample_bytree = c( 1),
  subsample = c(0.95),
  gamma = c(0),
  min_child_weight = c(0)
)

# Set the proportion for the test set (e.g., 0.2 for 20% test data)

test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput %>%  select(features,Label) %>% scale() %>% data.table() %>% drop_na()
index <- caret::createDataPartition(Xgboostinput_filtered$p_value_mort, p = test_proportion, list = FALSE)
# Split the data into training and test sets
train_data <- Xgboostinput_filtered[index, ]
test_data <- Xgboostinput_filtered[-index, ]


# Train the XGBoost model using the function
trainedModel<- train_xgboost_model(train_data, Label, features, custom_control, param_grid)

# Assuming you have the 'finalmodel' and 'test_data' from the previous steps
predictedValue<-postResample(
      predict(trainedModel, 
          test_data %>% dplyr::select(features)),  
        test_data %>% pull(Label)
      )
predictedValue


```

## shapley
```{r}
#shap_values <- shap.values(xgb_model = trainedModel$finalModel, X_train = as.matrix(train_data %>% dplyr::select(all_of(features))))
xgboost::xgb.ggplot.shap.summary(data = as.matrix(train_data %>% 
  dplyr::select(features)),
  model = trainedModel$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "left")
```

```{r}
xgboost::xgb.plot.shap(
  data = as.matrix(train_data %>% 
  dplyr::select(features)),
  model = trainedModel$finalModel,
  top_n = 9,
  n_col = 3
)
```




## PC Components of the WDI prediction Shapley values

```{r}
listi<-list.files("../output/wdi_dim_corr/summarystat_pc/")

entireListi<-data.frame()
for(i in 1:length(listi)){
  a<-fread(paste0("../output/wdi_dim_corr/summarystat_pc/",listi[i]))
  
  entireListi<- rbind(entireListi,a)
}
options(scipen = 999)
entireListi %>%  unique-> asd
merge(wdi_explained[,c(1:3)],asd,by.x="Series Code",by.y="Indicator")->energyCor
PC6_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC6)) %>%  slice(1:10)
PC10_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC10)) %>%  slice(1:100)
PC8_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC8)) %>%  slice(1:10)
PC1_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC1)) %>%  slice(1:10)
PC2_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC2)) %>%  slice(1:10)
```
### Conclusion PC analysis
1. PC1 is clearly demographics (like in iso 1). 
2. PC6 is correlated to indicators that are connected to geographics: explicit like intentional homocides (latin america), Food insecurity (Subsaharan and northern africa) and Statistical performance indicators, where former soviet states are very high. But also "Compensation of employees" which is very low in the soviets and laborforce/unemployment. Especially these indicators are positive correlated with ExMort.
3. PC10 Air pollution and public sector. Many indicators like CO2 emissions. These covers the "undefined third croup of covid death". SH.MED.BEDS.ZS high for soviets very low for latin america
4. PC8 GDP and electricity.

# B: Agnost ISO shapley 

```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier)))) 


```


```{r}
Label<-"p_value_mort"
#features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14")
features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7")

set.seed(123)
custom_control <- trainControl(
  method = "cv",
  number = 30,  # Increase the number of folds
  search = "random",
  allowParallel = TRUE
  
)

param_grid <- expand.grid(
  nrounds = c(50,100),
  eta = c(0.05),
  max_depth = c(2, 4),
  colsample_bytree = c( 1),
  subsample = c(1),
  gamma = c(0),
  min_child_weight = c(0)
)

# Set the proportion for the test set (e.g., 0.2 for 20% test data)

test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput %>%  select(features,Label) %>% drop_na()
index <- caret::createDataPartition(Xgboostinput_filtered$p_value_mort, p = test_proportion, list = FALSE)
# Split the data into training and test sets
train_data <- Xgboostinput_filtered[index, ]
test_data <- Xgboostinput_filtered[-index, ]


# Train the XGBoost model using the function
trainedModel<- train_xgboost_model(train_data, Label, features, custom_control, param_grid)

# Assuming you have the 'finalmodel' and 'test_data' from the previous steps
predictedValue<-postResample(
      predict(trainedModel, 
          test_data %>% dplyr::select(features)),  
        test_data %>% pull(Label)
      )
predictedValue


```

## shapley
```{r}
#shap_values <- shap.values(xgb_model = trainedModel$finalModel, X_train = as.matrix(train_data %>% dplyr::select(all_of(features))))
xgboost::xgb.ggplot.shap.summary(data = as.matrix(train_data %>% 
  dplyr::select(features)),
  model = trainedModel$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "left")
```

```{r}
xgboost::xgb.plot.shap(
  data = as.matrix(train_data %>% 
  dplyr::select(features)),
  model = trainedModel$finalModel,
  top_n = 9,
  n_col = 3
)
```




## PC Components of the WDI prediction Shapley values

```{r}
listi<-list.files("../output/wdi_dim_corr/summarystat/")

entireListi<-data.frame()
for(i in 1:length(listi)){
  a<-fread(paste0("../output/wdi_dim_corr/summarystat/",listi[i]))
 entireListi<- rbind(entireListi,a)
}

merge(wdi_explained[,c(1:3)],entireListi,by.x="Series Code",by.y="indiacator")->wdi_isolist
wdi_isolist %>%  filter(`Series Code` %in%"SI.POV.GINI") %>% ggplot(aes(x=value,y=yhat,color=key))+geom_smooth()+ geom_line()+ scale_color_viridis(discrete = T)+theme_bw()

wdi_isolist$yhat %>%  summary

wdi_isolist %>%  filter(key%in% "iso4") %>% filter(value< -0.5, yhat>0.85)
```
### Conclusion PC analysis
1. PC1 is clearly demographics (like in iso 1). 
2. PC6 is correlated to indicators that are connected to geographics: explicit like intentional homocides (latin america), Food insecurity (Subsaharan and northern africa) and Statistical performance indicators, where former soviet states are very high. But also "Compensation of employees" which is very low in the soviets and laborforce/unemployment. Especially these indicators are positive correlated with ExMort.
3. PC10 Air pollution and public sector. Many indicators like CO2 emissions. These covers the "undefined third croup of covid death". SH.MED.BEDS.ZS high for soviets very low for latin america
4. PC8 GDP and electricity.

# C PCA model is as good as ISO

```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))



```




```{r}
Label<-"p_value_mort"
features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14")

features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","new_cases_smoothed_per_million","meanTemp")

set.seed(123)
custom_control <- trainControl(
  method = "cv",
  number = 30,  # Increase the number of folds
  search = "random",
  allowParallel = TRUE
  
)

param_grid <- expand.grid(
  nrounds = c(50,100),
  eta = c(0.05),
  max_depth = c(2, 4),
  colsample_bytree = c( 1),
  subsample = c(1),
  gamma = c(0),
  min_child_weight = c(0)
)

# Set the proportion for the test set (e.g., 0.2 for 20% test data)

test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput %>%  select(features,Label) %>% scale() %>% data.table() %>% drop_na()
index <- caret::createDataPartition(Xgboostinput_filtered$p_value_mort, p = test_proportion, list = FALSE)
# Split the data into training and test sets
train_data <- Xgboostinput_filtered[index, ]
test_data <- Xgboostinput_filtered[-index, ]


# Train the XGBoost model using the function
trainedModel<- train_xgboost_model(train_data, Label, features, custom_control, param_grid)

# Assuming you have the 'finalmodel' and 'test_data' from the previous steps
predictedValue<-postResample(
      predict(trainedModel, 
          test_data %>% dplyr::select(features)),  
        test_data %>% pull(Label)
      )
predictedValue


#shap_values <- shap.values(xgb_model = trainedModel$finalModel, X_train = as.matrix(train_data %>% dplyr::select(all_of(features))))
xgboost::xgb.ggplot.shap.summary(data = as.matrix(train_data %>% 
  dplyr::select(features)),
  model = trainedModel$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "left")
```
```{r}
xgboost::xgb.plot.shap(
  data = as.matrix(train_data %>% 
  dplyr::select(features)),
  model = trainedModel$finalModel,
  top_n = 9,
  n_col = 3
)
```


```{r}
PC10_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC10))
PC8_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC8)) %>%  slice(1:10)
PC1_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC1))
PC2_contribution<-asda %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2)) %>% arrange(desc(PC2))

PC4_contribution<-asda %>% arrange(desc(PC4))
```

```{r}
listi<-list.files("../output/wdi_dim_corr/summarystat_pearson/")

entireListi_pearson<-data.frame()
for(i in 1:length(listi)){
  a<-fread(paste0("../output/wdi_dim_corr/summarystat_pearson/",listi[i]))
  
  entireListi_pearson<- rbind(entireListi_pearson,a)
}

merge(wdi_explained[,c(1:3)],entireListi_pearson,by.x="Series Code",by.y="Indicator")->wdi_pc


```
```{r}
combinCorPCA_inDimred<-merge(energyCor,wdi_pc[,c(1,4,5:17)],by="Series Code",suffixes = c(".energy","pearson"))  %>%filter(`Series Code`%in% colnames(dimred2021_knn250_2))

# combinCorPCA_inDimred %>% fwrite("../data/08_wdi_pca_correlation.csv")
combinCorPCA_inDimred<-fread("../data/08_wdi_pca_correlation.csv")
```


### PC1
```{r}
dimred2021_knn250_5$PC1<-dimred2021_knn250_5$PC1 %>%  scale  %>% as.vector()
dimred2021_knn250_5 %>%  filter(PC1>0.5) %>% select(`Country Name`,`Income Group`) %>%  unique->testIncome
combinCorPCA_inDimred %>%  arrange(desc(PC1.energy)) %>% select(1,2,3,4,18)-> PC1subset
```

### PC2
```{r}
dimred2021_knn250_5$PC2<-dimred2021_knn250_5$PC2 %>%  scale  %>% as.vector()
dimred2021_knn250_5 %>%  filter(PC2>0.5) %>% select(`Country Name`,`Income Group`) %>%  unique->testIncome
combinCorPCA_inDimred %>%  arrange(desc(PC2.energy)) %>% select(1,2,3,5,19)-> PC2subset
```

### PC10
```{r}
dimred2021_knn250_5$PC12<-dimred2021_knn250_5$PC1 %>%  scale  %>% as.vector()
dimred2021_knn250_5$PC12 %>%  summary
dimred2021_knn250_5 %>%  filter(PC12< -0.5) %>% select(`Country Name`,`Income Group`) %>%  unique->testIncome
combinCorPCA_inDimred %>%  arrange(desc(PC10.energy)) %>% select(1,2,3,13,27)-> PC2subset
```

# SHAP force plots
The SHAP force plot basically stacks these SHAP values for each observation, and show how the final output was obtained as a sum of each predictorâ€™s attributions.

 choose to show top 4 features by setting `top_n = 4`, 
 set 6 clustering groups of observations.  
plot_data <- shap.prep.stack.data(shap_contrib = shap_values$shap_score, top_n = 4, n_groups = 6)
 you may choose to zoom in at a location, and set y-axis limit using `y_parent_limit`  
shap.plot.force_plot(plot_data, zoom_in_location = 5000, y_parent_limit = c(-0.1,0.1))
```{r}

```

# D Visualization of Dimred

```{r}
# Install and load necessary packages
#install.packages(c("ggplot2", "sf", "rnaturalearth", "dplyr"))
library(ggplot2)
library(sf)
library(rnaturalearth)
library(dplyr)
require(scales)
# Get world data
world <- ne_countries(scale = "medium", returnclass = "sf")


dimred2021_knn250_2 %>% filter(year%in% 2019)  %>% 
  mutate(iso_a3 = `Country Code`,
        var1 = iso4,
        var2 = pscore_mean)   %>%  unique() %>% select(iso_a3,var1,var2) -> data2
merge( world %>% select(iso_a3,iso_a2) %>% data.frame(),data2,by="iso_a3",all.x=T) %>% select(iso_a3,var1,var2) %>% 
  mutate(var1=rescale(var1, to = c(0, 1)),var2=rescale(var2, to = c(0, 1)))%>% mutate(var1=if_else(is.na(var1),0,var1),var2=if_else(is.na(var2),0,var2))-> data3


# Merge example data with spatial data
world_data <- left_join(world, data3, by = "iso_a3")

# Create bivariate color scale: var1 influences red, var2 influences blue
world_data$color <- with(world_data, rgb(var1, 0, var2, maxColorValue = 1))

# Plot the world map using the bivariate color scheme
ggplot(data = world_data) + 
  geom_sf(aes(fill = color)) + 
  scale_fill_identity() +
  theme_minimal() + 
  labs(title = "Bivariate Color Map: Red (Iso4) vs. Blue (Exmort)")

```


#E complete model

rerun with extra and with region and with month
##I Confounder correlatioin

```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))
load("../data/06_230504_dimred_covar_set_vanilla")


dim_features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14")

features1<-c("new_cases_smoothed_per_million","diffTemp","stringency_index")
feature_vector <- c(
  "urban_percent",
  "Med_recources_m",
  "med_UHD",
  "life_expectancy",
  "mortality_m",
  #"int_tourism",
  "older65",
  "younger14",
  "rural_percent",
  "urban_percent",
  "digitalisation_1",
  "health_spending_percent",
 # "HCI",
  "obesity",
  "immunization_bad",
  "comorb_m_unscaled",
 # "household_avg",
  "airpolution_avg"
  #"mean_Dalyrate"

)
subsetCovar<-Dimred_covar_set_vanilla %>% select(`Country Code`,feature_vector)
correlationTable<-dimred2021_knn250_5 %>%  filter(year %in% 2019) %>% select(`Country Code`,dim_features) %>%  drop_na() %>% 
  inner_join( . ,subsetCovar,by="Country Code") %>% select(-(`Country Code`)) %>%  drop_na() %>% rename("Urban area(%)" ="urban_percent", 
              "Med. Infr"= "Med_recources_m", "UHC index"="med_UHD", "Life expectancy"="life_expectancy", "Morality index"="mortality_m", 
              "Pop > 65"="older65","Pop < 14 "= "younger14","Digitalisation Index"= "digitalisation_1", 
               "Health spending"="health_spending_percent","Prevalence Obesity"= "obesity", "Imunization general"="immunization_bad", "Cormodity Index"="comorb_m_unscaled","Air pollution"="airpolution_avg")

corr <- round(abs(cor(correlationTable)), 1)
a<-ggcorrplot(corr, type = "upper",
   lab = F) + scale_fill_viridis()+ theme_classic2()+theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

ggsave("../figures/08_corr_covars_pca.png",device = "png")
```


```{r}
dim_features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7")


correlationTable<-dimred2021_knn250_5 %>%  filter(year %in% 2019) %>% select(`Country Code`,dim_features) %>%  drop_na() %>% 
  inner_join( . ,subsetCovar,by="Country Code") %>% select(-(`Country Code`)) %>%  drop_na() %>% rename("Urban area(%)" ="urban_percent", 
              "Med. Infr"= "Med_recources_m", "UHC index"="med_UHD", "Life expectancy"="life_expectancy", "Morality index"="mortality_m", 
              "Pop > 65"="older65","Pop < 14 "= "younger14","Digitalisation Index"= "digitalisation_1", 
               "Health spending"="health_spending_percent","Prevalence Obesity"= "obesity", "Imunization general"="immunization_bad", "Cormodity Index"="comorb_m_unscaled","Air pollution"="airpolution_avg")

corr <- round(abs(cor(correlationTable)), 1)

b<-ggcorrplot(corr, type = "upper",
   lab = F) + scale_fill_viridis()+ theme_classic2()+theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
b
ggsave("../figures/08_corr_covars_iso.png",device = "png")
```
```{r}
dim_features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","yearmon")
# dim_features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","yearmon")
features1<-c("new_cases_smoothed_per_million","diffTemp","stringency_index","weekly_icu_admissions","new_people_vaccinated_smoothed_per_hundred","weekly_hosp_admissions_per_million","diffTemp")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))


dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% 
  merge(Xgboostinput, . ,by = "Country Code")-> Xgboostinput_covar_1b
Xgboostinput_covar2<-Xgboostinput_covar_1b%>%select(any_of(c(feature_vector,dim_features,features1,"p_value_mort"))) %>%  drop_na() %>% 
  rename("New cases"=new_cases_smoothed_per_million,"Vaccinations"=new_people_vaccinated_smoothed_per_hundred,"ICU/Week"=weekly_icu_admissions,"Hosp/Week"=weekly_hosp_admissions_per_million,"Excess Mortality"=p_value_mort,"Month in pandemic"=yearmon,"Var(Temp)"=diffTemp)


corr <- round(abs(cor(Xgboostinput_covar2)), 2)
corr
ggcorrplot(corr, type = "upper",
   lab = F) + scale_fill_viridis()+ theme_classic2()+theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
ggsave("../figures/08_corr_monthly_PCA.png",device = "png")
```


##II  PCA and ISO model
```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))
load("../data/06_230504_dimred_covar_set_vanilla")
```

time layer
```{r}
# 
# Xgboostinput_covar_1b %>%  arrange(`Country Code`,year.x,month.x) %>% group_by(`Country Code`) %>% mutate(MonthIndex = row_number(`Country Code`)) ->Xgboostinput_covar_1c
# thesecountrieshaveallthemonth<-Xgboostinput_covar_1c %>% group_by(`Country Code`) %>% summarise(enoughMonth=length(MonthIndex)) %>%  filter(enoughMonth%in% 22)
# 
# Xgboostinput_covar2<-Xgboostinput_covar_1c %>%
#   filter(`Country Code`%in%thesecountrieshaveallthemonth$`Country Code` ) %>%  select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Regions","Country Code","MonthIndex"))) %>%  drop_na()
# Xgboostinput_covar2$Country <- as.factor(Xgboostinput_covar2$`Country Code`) %>%  as.numeric()
# features_time<-c(features,"Country","MonthIndex","Regions")
# Xgboostinput_covar2$Country <- as.factor(Xgboostinput_covar2$`Country Code`) %>%  as.numeric()
# features_time<-c(features,"Country","MonthIndex","Regions")
# test_proportion <- 0.8
# Xgboostinput_filtered<-Xgboostinput_covar2 %>%  ungroup() %>%  select(any_of(c(features_time,Label))) %>% scale() %>% data.frame() %>% drop_na()
# Xgboostinput_filtered %>% group_by(Country) %>% mutate(MonthIndex = row_number(Country))->Xgboostinput_filtered2
```


```{r}


dim_features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","yearmon")

features1<-c("new_cases_smoothed_per_million","diffTemp","stringency_index")
feature_vector <- c(
  "urban_percent",
  "Med_recources_m",
  "med_UHD",
  "life_expectancy",
  "mortality_m",
  #"int_tourism",
  "older65",
  "younger14",
  "rural_percent",
  "urban_percent",
  "digitalisation_1",
  "health_spending_percent",
 # "HCI",
  "obesity",
  "immunization_bad",
  "comorb_m_unscaled",
 # "household_avg",
  "airpolution_avg"
  #"mean_Dalyrate"

)
Xgboostinput$identifer3<-str_remove(Xgboostinput$identifier_CountryYear,"_2020")
Xgboostinput$identifer3<-str_remove(Xgboostinput$identifer3,"_2021")
subsetCovar<-Dimred_covar_set_vanilla %>% select(`Country Code`,feature_vector)

subsetCovar<-subsetCovar[,] %>%  select(colnames(subsetCovar)[!(colnames(subsetCovar)%in% colnames(Xgboostinput))],"Country Code") 
subsetCovar$household_avg <-NULL
subsetCovar$HCI<-NULL
subsetCovar$mean_Dalyrate<-NULL
subsetCovar$airpolution_avg<-NULL
subsetCovar %>% apply( . ,2,function(x)sum(is.na(x)))
Xgboostinput_covar<-merge(Xgboostinput,subsetCovar,by.x="identifer3",by.y="Country Code")

dim_featuresISO<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","iso8","iso9","iso10","iso11","iso12","iso13","iso14","iso15","iso16","iso17","iso18","iso19","iso20")
dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% 
  merge(Xgboostinput_covar, . ,by = "Country Code")-> Xgboostinput_covar_1b
Xgboostinput_covar2<-Xgboostinput_covar_1b%>%select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Regions",dim_featuresISO))) %>%  drop_na()


```


```{r}
Label<-"p_value_mort"

features2<-feature_vector
features3<-dim_features

#features<-c(features1,features2,features3,dim_featuresISO)
features<-c(features1,features2,features3)
set.seed(123)
custom_control <- trainControl(
  method = "cv",
  number =12,  # Increase the number of folds
  allowParallel = TRUE
  
)
doMC::registerDoMC(50)
param_grid <- expand.grid(
  nrounds = c(50,100),
  eta = c(0.3),
  max_depth = c(3,6),
  gamma = c(0, 0.1, 1, 2),
  colsample_bytree = c( 0.9,1),
  min_child_weight = c(1, 3, 5),
  subsample = c( 0.9)
)

# Set the proportion for the test set (e.g., 0.2 for 20% test data)

Xgboostinput<-Xgboostinput_covar2%>% scale() %>% data.table() %>% drop_na() %>% rename("New Cases"="new_cases_smoothed_per_million", "Diff Temp"="diffTemp","Oxford stringency"="stringency_index","Urban area(%)" ="urban_percent", 
              "Medical infrastructure index"= "Med_recources_m", "UHC index"="med_UHD", "Life expectancy"="life_expectancy", "Morality index"="mortality_m", 
              "Pop > 65"="older65","Pop < 14 "= "younger14","Digitalisation Index"= "digitalisation_1", 
               "Health spending"="health_spending_percent","Prevalence Obesity"= "obesity", "Imunization general"="immunization_bad", "Corbodity Index"="comorb_m_unscaled")


# features<-Xgboostinput %>%  select(-Label) %>% colnames()
features<-Xgboostinput %>%  select(-c(1:13,15),-Label) %>% colnames()
features
test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput
index <- caret::createDataPartition(Xgboostinput$p_value_mort, p = test_proportion, list = FALSE)
# Split the data into training and test sets
train_data <- Xgboostinput[index, ]
test_data <- Xgboostinput[-index, ]

# doMC::registerDoMC(50)
#  # Test different parameters
xgb_caret_pca <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),tuneGrid = param_grid,trControl = custom_control,
  method = "xgbTree",
  verbosity = 1
)

#save(xgb_caret_pca,file = "../output/07_results4_pca_trained")
finalmodel_pca <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),
  method = "xgbTree",
  verbosity = 0,
  trControl = trainControl(method = "cv", number = 12),
  tuneGrid = xgb_caret_pca$bestTune
)
#save(finalmodel_pca,file = "../output/07_results4_pca_final")
 #load(file = "../output/07_results3_pca_final")  



# Assuming you have the 'finalmodel' and 'test_data' from the previous steps
predictedValue<-postResample(
      predict(finalmodel_pca, 
          test_data %>% dplyr::select(any_of(features))),  
        test_data %>% pull(Label)
      )
predictedValue


#shap_values <- shap.values(xgb_model = trainedModel$finalModel, X_train = as.matrix(train_data %>% dplyr::select(all_of(features))))
xgboost::xgb.ggplot.shap.summary(top_n = 12,data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_pca$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "leaft")
```
```{r}
xgboost::xgb.plot.shap(
  data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_pca$finalModel,
  top_n = 12,
  n_col = 3
)
```


##  PCA model
```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))
load("../data/06_230504_dimred_covar_set_vanilla")
```

time layer
```{r}
# 
# Xgboostinput_covar_1b %>%  arrange(`Country Code`,year.x,month.x) %>% group_by(`Country Code`) %>% mutate(MonthIndex = row_number(`Country Code`)) ->Xgboostinput_covar_1c
# thesecountrieshaveallthemonth<-Xgboostinput_covar_1c %>% group_by(`Country Code`) %>% summarise(enoughMonth=length(MonthIndex)) %>%  filter(enoughMonth%in% 22)
# 
# Xgboostinput_covar2<-Xgboostinput_covar_1c %>%
#   filter(`Country Code`%in%thesecountrieshaveallthemonth$`Country Code` ) %>%  select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Regions","Country Code","MonthIndex"))) %>%  drop_na()
# Xgboostinput_covar2$Country <- as.factor(Xgboostinput_covar2$`Country Code`) %>%  as.numeric()
# features_time<-c(features,"Country","MonthIndex","Regions")
# Xgboostinput_covar2$Country <- as.factor(Xgboostinput_covar2$`Country Code`) %>%  as.numeric()
# features_time<-c(features,"Country","MonthIndex","Regions")
# test_proportion <- 0.8
# Xgboostinput_filtered<-Xgboostinput_covar2 %>%  ungroup() %>%  select(any_of(c(features_time,Label))) %>% scale() %>% data.frame() %>% drop_na()
# Xgboostinput_filtered %>% group_by(Country) %>% mutate(MonthIndex = row_number(Country))->Xgboostinput_filtered2
```


```{r}


dim_features<-c("iso4","PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","yearmon")

features1<-c("new_cases_smoothed_per_million","diffTemp","stringency_index")
feature_vector <- c(
  "urban_percent",
  "Med_recources_m",
  "med_UHD",
  "life_expectancy",
  "mortality_m",
  #"int_tourism",
  "older65",
  "younger14",
  "rural_percent",
  "urban_percent",
  "digitalisation_1",
  "health_spending_percent",
 # "HCI",
  "obesity",
  "immunization_bad",
  "comorb_m_unscaled",
 # "household_avg",
  "airpolution_avg"
  #"mean_Dalyrate"

)
Xgboostinput$identifer3<-str_remove(Xgboostinput$identifier_CountryYear,"_2020")
Xgboostinput$identifer3<-str_remove(Xgboostinput$identifer3,"_2021")
subsetCovar<-Dimred_covar_set_vanilla %>% select(`Country Code`,feature_vector)

subsetCovar<-subsetCovar[,] %>%  select(colnames(subsetCovar)[!(colnames(subsetCovar)%in% colnames(Xgboostinput))],"Country Code") 
subsetCovar$household_avg <-NULL
subsetCovar$HCI<-NULL
subsetCovar$mean_Dalyrate<-NULL
subsetCovar$airpolution_avg<-NULL
subsetCovar %>% apply( . ,2,function(x)sum(is.na(x)))
Xgboostinput_covar<-merge(Xgboostinput,subsetCovar,by.x="identifer3",by.y="Country Code")

dim_featuresISO<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","iso8","iso9","iso10","iso11","iso12","iso13","iso14","iso15","iso16","iso17","iso18","iso19","iso20")

dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% 
  merge(Xgboostinput_covar, . ,by = "Country Code")-> Xgboostinput_covar_1b
Xgboostinput_covar2<-Xgboostinput_covar_1b%>%select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Regions",dim_featuresISO))) %>%  drop_na()


```


```{r}
Label<-"iso4"
features2<-feature_vector
features3<-dim_features
features3
#features<-c(features1,features2,features3,dim_featuresISO)
features<-c(features1,features2,features3)
set.seed(123)
custom_control <- trainControl(
  method = "cv",
  number =12,  # Increase the number of folds
  allowParallel = TRUE
  
)
doMC::registerDoMC(50)
param_grid <- expand.grid(
  nrounds = c(50,100),
  eta = c(0.3),
  max_depth = c(3,6),
  gamma = c(0, 0.1, 1, 2),
  colsample_bytree = c( 0.9,1),
  min_child_weight = c(1, 3, 5),
  subsample = c( 0.9)
)

# Set the proportion for the test set (e.g., 0.2 for 20% test data)

Xgboostinput<-Xgboostinput_covar2$%>% scale() %>% data.table() %>% drop_na() %>% rename("New Cases"="new_cases_smoothed_per_million", "Diff Temp"="diffTemp","Oxford stringency"="stringency_index","Urban area(%)" ="urban_percent", 
              "Medical infrastructure index"= "Med_recources_m", "UHC index"="med_UHD", "Life expectancy"="life_expectancy", "Morality index"="mortality_m", 
              "Pop > 65"="older65","Pop < 14 "= "younger14","Digitalisation Index"= "digitalisation_1", 
               "Health spending"="health_spending_percent","Prevalence Obesity"= "obesity", "Imunization general"="immunization_bad", "Corbodity Index"="comorb_m_unscaled")


# features<-Xgboostinput %>%  select(-Label) %>% colnames()
features<-Xgboostinput %>%  select(-c(1:13,15,34:53),-Label) %>% colnames()
Xgboostinput %>%  head
```


```{r}
test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput
index <- caret::createDataPartition(Xgboostinput$p_value_mort, p = test_proportion, list = FALSE)
# Split the data into training and test sets
train_data <- Xgboostinput[index, ]
test_data <- Xgboostinput[-index, ]

# doMC::registerDoMC(50)
#  # Test different parameters
xgb_caret_pca <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),tuneGrid = param_grid,trControl = custom_control,
  method = "xgbTree",
  verbosity = 1
)

#save(xgb_caret_pca,file = "../output/07_results4_pca_trained")
finalmodel_pca <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),
  method = "xgbTree",
  verbosity = 0,
  trControl = trainControl(method = "cv", number = 12),
  tuneGrid = xgb_caret_pca$bestTune
)
#save(finalmodel_pca,file = "../output/07_results4_pca_final")
 #load(file = "../output/07_results3_pca_final")  



# Assuming you have the 'finalmodel' and 'test_data' from the previous steps
predictedValue<-postResample(
      predict(finalmodel_pca, 
          test_data %>% dplyr::select(any_of(features))),  
        test_data %>% pull(Label)
      )
predictedValue


#shap_values <- shap.values(xgb_model = trainedModel$finalModel, X_train = as.matrix(train_data %>% dplyr::select(all_of(features))))
xgboost::xgb.ggplot.shap.summary(top_n = 12,data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_pca$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "leaft")
```
```{r}
xgboost::xgb.plot.shap(
  data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_pca$finalModel,
  top_n = 12,
  n_col = 3
)
```

##  ISO model
```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))
load("../data/06_230504_dimred_covar_set_vanilla")
```


```{r}


dim_features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","iso8","iso9","iso10","iso11","iso12","iso13","iso14","iso15","iso16","iso17","iso18","iso19","iso20")

features1<-c("new_cases_smoothed_per_million","meanTemp","stringency_index")
feature_vector <- c(
  "urban_percent",
  "Med_recources_m",
  "med_UHD",
  "life_expectancy",
  "mortality_m",
  #"int_tourism",
  "older65",
  "younger14",
  "rural_percent",
  "urban_percent",
  "digitalisation_1",
  "health_spending_percent",
 # "HCI",
  "obesity",
  "immunization_bad",
  "comorb_m_unscaled",
 # "household_avg",
  "airpolution_avg"
  #"mean_Dalyrate"

)
Xgboostinput$identifer3<-str_remove(Xgboostinput$identifier_CountryYear,"_2020")
Xgboostinput$identifer3<-str_remove(Xgboostinput$identifer3,"_2021")
subsetCovar<-Dimred_covar_set_vanilla %>% select(`Country Code`,feature_vector)

subsetCovar<-subsetCovar[,] %>%  select(colnames(subsetCovar)[!(colnames(subsetCovar)%in% colnames(Xgboostinput))],"Country Code") 
subsetCovar$household_avg <-NULL
subsetCovar$HCI<-NULL
subsetCovar$mean_Dalyrate<-NULL
subsetCovar$airpolution_avg<-NULL
subsetCovar %>% apply( . ,2,function(x)sum(is.na(x)))
Xgboostinput_covar<-merge(Xgboostinput,subsetCovar,by.x="identifer3",by.y="Country Code")

dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% 
  merge(Xgboostinput_covar, . ,by = "Country Code")-> Xgboostinput_covar_1b
Xgboostinput_covar2<-Xgboostinput_covar_1b%>%select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Regions"))) %>%  drop_na()


```


time layer
```{r}
Xgboostinput_covar_1b %>%  arrange(`Country Code`,year.x,month.x) %>% group_by(`Country Code`) %>% mutate(MonthIndex = row_number(`Country Code`)) ->Xgboostinput_covar_1c
thesecountrieshaveallthemonth<-Xgboostinput_covar_1c %>% group_by(`Country Code`) %>% summarise(enoughMonth=length(MonthIndex)) %>%  filter(enoughMonth%in% 22)

Xgboostinput_covar2<-Xgboostinput_covar_1c %>%
  filter(`Country Code`%in%thesecountrieshaveallthemonth$`Country Code` ) %>%  select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Regions","Country Code","MonthIndex"))) %>%  drop_na()
Xgboostinput_covar2$Country <- as.factor(Xgboostinput_covar2$`Country Code`) %>%  as.numeric()
features_time<-c(features,"Country","MonthIndex","Regions")
Xgboostinput_covar2$Country <- as.factor(Xgboostinput_covar2$`Country Code`) %>%  as.numeric()
features_time<-c(features,"Country","MonthIndex","Regions")
test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput_covar2 %>%  ungroup() %>%  select(any_of(c(features_time,Label))) %>% scale() %>% data.frame() %>% drop_na()
Xgboostinput_filtered %>% group_by(Country) %>% mutate(MonthIndex = row_number(Country))->Xgboostinput_filtered2
```


```{r}
Label<-"p_value_mort"

features2<-feature_vector
features3<-c(dim_features,"MonthIndex","Regions")
features<-c(features1,features2,features3,"Regions") %>%  unique()

set.seed(123)
custom_control <- trainControl(
  method = "cv",
  number = 12,  # Increase the number of folds
  allowParallel = TRUE
  
)

param_grid <- expand.grid(
  nrounds = c(50,100,200),
  eta = c(0.05,0.1,0.3),
  max_depth = c(3, 4,6,8),
  gamma = c(0, 0.1, 1, 2),
  colsample_bytree = c(0.5, 0.7, 0.9,1),
  min_child_weight = c(1, 3, 5),
  subsample = c(0.5, 0.7, 0.9)
)

# Set the proportion for the test set (e.g., 0.2 for 20% test data)

test_proportion <- 0.8
#Xgboostinput_filtered<-Xgboostinput_covar2 %>%  select(any_of(c(features,Label))) %>% scale() %>% data.table() %>% drop_na()


Xgboostinput<-Xgboostinput_filtered2%>% scale() %>% data.table() %>% drop_na() %>% rename("New Cases"="new_cases_smoothed_per_million", "Mean temperature"="meanTemp","Oxford stringency"="stringency_index","Urban area(%)" ="urban_percent", 
              "Medical infrastructure index"= "Med_recources_m", "UHC index"="med_UHD", "Life expectancy"="life_expectancy", "Morality index"="mortality_m", 
              "Pop > 65"="older65","Pop < 14 "= "younger14","Digitalisation Index"= "digitalisation_1", 
               "Health spending"="health_spending_percent","Prevalence Obesity"= "obesity", "Imunization general"="immunization_bad", "Corbodity Index"="comorb_m_unscaled")

features<-Xgboostinput %>%  select(-Label,-paste0("iso",8:20)) %>% colnames()


index <- caret::createDataPartition(Xgboostinput$p_value_mort, p = test_proportion, list = FALSE)
# Split the data into training and test sets
train_data <- Xgboostinput[index, ]
test_data <- Xgboostinput[-index, ]

# doMC::registerDoMC(50)
#  # Test different parameters
xgb_caret_iso <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),tuneGrid = param_grid,trControl = custom_control,
  method = "xgbTree",
  verbosity = 1
)
#load("../output/07_results3_iso_trained")
save(xgb_caret_iso,file = "../output/07_results_best_iso_trained")
finalmodel_iso <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),
  method = "xgbTree",
  verbosity = 0,
  trControl = trainControl(method = "cv", number = 30),
  tuneGrid = xgb_caret_iso$bestTune
)
save(finalmodel_iso,file = "../output/07_results_best_iso_trained")
#load("../output/07_results3_iso_trained")
# load(file = "../output/07_results3_iso_final")  



# Assuming you have the 'finalmodel' and 'test_data' from the previous steps
predictedValue<-postResample(
      predict(finalmodel_iso, 
          test_data %>% dplyr::select(any_of(features))),  
        test_data %>% pull(Label)
      )
predictedValue


#shap_values <- shap.values(xgb_model = trainedModel$finalModel, X_train = as.matrix(train_data %>% dplyr::select(all_of(features))))
xgboost::xgb.ggplot.shap.summary(top_n = 12,data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_iso$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "lefts")
```

## PC as time series
```{r}
Xgboostinput_covar_1b %>%  arrange(`Country Code`,year.x,month.x) %>% group_by(`Country Code`) %>% mutate(MonthIndex = row_number(`Country Code`)) ->Xgboostinput_covar_1c
thesecountrieshaveallthemonth<-Xgboostinput_covar_1c %>% group_by(`Country Code`) %>% summarise(enoughMonth=length(MonthIndex)) %>%  filter(enoughMonth%in% 22)

Xgboostinput_covar2<-Xgboostinput_covar_1c %>%
  filter(`Country Code`%in%thesecountrieshaveallthemonth$`Country Code` ) %>%  select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Regions","Country Code","MonthIndex"))) %>%  drop_na()


```


```{r}
Xgboostinput_covar2$Country <- as.factor(Xgboostinput_covar2$`Country Code`) %>%  as.numeric()
features_time<-c(features,"Country","MonthIndex","Regions")
test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput_covar2 %>%  ungroup() %>%  select(any_of(c(features_time,Label))) %>% scale() %>% data.frame() %>% drop_na()
Xgboostinput_filtered %>% group_by(Country) %>% mutate(MonthIndex = row_number(Country))->Xgboostinput_filtered2
  
thesecountrieshaveallthemonth<-Xgboostinput_filtered2 %>% group_by(Country) %>% summarise(enoughMonth=length(MonthIndex)) %>%  filter(enoughMonth%in% 22)
Xgboostinput_filtered %>% filter(Country %in% thesecountrieshaveallthemonth$Country)-> Xgboostinput_filtered

# Create train/test split for time series data

index <- createTimeSlices(1:nrow(Xgboostinput_filtered),
                          initialWindow = 22, # initial number of data points 
                          horizon = 22, # number of data points for each forecast
                          fixedWindow = TRUE)

trainIndex <- index[[1]] 
testIndex <- index[[2]]



# Create trainControl

custom_control <- trainControl(
  method = "timeslice",
                     index = trainIndex,
                     indexOut = testIndex
  
)

# param_grid <- expand.grid(
#   nrounds = c(50,100,200),
#   eta = c(0.05,0.1,0.3),
#   max_depth = c(3, 4,6,8),
#   gamma = c(0, 0.1, 1, 2),
#   colsample_bytree = c(0.5, 0.7, 0.9,1),
#   min_child_weight = c(1, 3, 5),
#   subsample = c(0.5, 0.7, 0.9)
# )
# tuneGrid = param_grid,
doMC::registerDoMC(50)
xgb_caret_iso <- caret::train(
  x = Xgboostinput_filtered %>% dplyr::select(any_of(features)),
  y = Xgboostinput_filtered %>% pull(Label),trControl = custom_control,
  method = "xgbTree",
  verbosity = 1
)
xgb_caret_iso$bestTune

finalmodel_iso <- caret::train(
  x = Xgboostinput_filtered %>% dplyr::select(any_of(features)),
  y = Xgboostinput_filtered %>% pull(Label),
  method = "xgbTree",
  verbosity = 0,
  trControl = custom_control,
  tuneGrid = xgb_caret_iso$bestTune
)
predictedValue<-postResample(
      predict(finalmodel_iso, 
          test_data %>% dplyr::select(any_of(features))),  
        test_data %>% pull(Label)
      )
predictedValue
xgboost::xgb.ggplot.shap.summary(data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_iso$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "left")
```

# Finalised Model

In this model we can see 
```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))
load("../data/06_230504_dimred_covar_set_vanilla")


#Xgboostinput %>%  filter(p_value_mort<18)-> Xgboostinput
this<-Xgboostinput %>%  filter(p_value_mort>18)

```


```{r}
dim_features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","yearmon")
#dim_features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","yearmon")
features1<-c("new_cases_smoothed_per_million","diffTemp","stringency_index","weekly_icu_admissions","new_people_vaccinated_smoothed_per_hundred","weekly_hosp_admissions_per_million","diffTemp")

Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))


dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% 
  merge(Xgboostinput, . ,by = "Country Code")-> Xgboostinput_covar_1b

Dimred_covar_set_vanilla %>%  select(`Country Code`,comorb_m_unscaled) %>% rename("Cormodity Index"="comorb_m_unscaled") %>% 
  merge( . ,Xgboostinput_covar_1b,by="Country Code")->Xgboostinput_covar_1c


Xgboostinput_covar2<-Xgboostinput_covar_1c%>%select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Cormodity Index"))) %>%  drop_na() %>% 
  rename("New cases"=new_cases_smoothed_per_million,"Vaccinations"=new_people_vaccinated_smoothed_per_hundred,"ICU/Week"=weekly_icu_admissions,"Hosp/Week"=weekly_hosp_admissions_per_million,"Excess Mortality"=p_value_mort,"Month in pandemic"=yearmon,"sd(Temp)"=diffTemp)

 

```

```{r}

Label<-"Excess Mortality"

features<-Xgboostinput_covar2 %>%  select(-Label,-life_expectancy) %>%  colnames()

#features<-c(features1,features2,features3,dim_featuresISO)
set.seed(123)
custom_control <- trainControl(
  method = "cv",
  number =12,  # Increase the number of folds
  allowParallel = TRUE
  
)
doMC::registerDoMC(50)
param_grid <- expand.grid(
  nrounds = c(50,100),
  eta = c(0.2,0.3),
  max_depth = c(3,6),
  gamma = c(0, 0.1, 1, 2),
  colsample_bytree = c( 0.9,1),
  min_child_weight = c(1, 3, 5),
  subsample = c( 0.9)
)

# Set the proportion for the test set (e.g., 0.2 for 20% test data)

Xgboostinput<-Xgboostinput_covar2



test_proportion <- 0.8
Xgboostinput_filtered<-Xgboostinput
index <- caret::createDataPartition(Xgboostinput$PC1, p = test_proportion, list = FALSE)
# Split the data into training and test sets
train_data <- Xgboostinput[index, ]
test_data <- Xgboostinput[-index, ]

# doMC::registerDoMC(50)
#  # Test different parameters
xgb_caret_pca <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),tuneGrid = param_grid,trControl = custom_control,
  method = "xgbTree",
  verbosity = 1
)

#save(xgb_caret_pca,file = "../output/07_results4_pca_trained")
finalmodel_pca <- caret::train(
  x = train_data %>% dplyr::select(any_of(features)),
  y = train_data %>% pull(Label),
  method = "xgbTree",
  verbosity = 0,
  trControl = trainControl(method = "cv", number = 12),
  tuneGrid = xgb_caret_pca$bestTune
)
#save(finalmodel_pca,file = "../output/07_results4_pca_final")
 #load(file = "../output/07_results3_pca_final")  



# Assuming you have the 'finalmodel' and 'test_data' from the previous steps
predictedValue<-postResample(
      predict(finalmodel_pca, 
          test_data %>% dplyr::select(any_of(features))),  
        test_data %>% pull(Label)
      )
predictedValue

#shap_values <- shap.values(xgb_model = trainedModel$finalModel, X_train = as.matrix(train_data %>% dplyr::select(all_of(features))))
xgboost::xgb.ggplot.shap.summary(top_n = 12,data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_pca$finalModel) +scale_color_viridis("Feature Value")+ theme_bw() + xlab("Features")+ylab("Shapley value")+theme(legend.position = "leaft")
```
```{r}
xgboost::xgb.plot.shap(
  data = as.matrix(train_data %>% 
  dplyr::select(any_of(features))),
  model = finalmodel_pca$finalModel,
  top_n = 12,
  n_col = 4
)
#ggsave("../figures/08_pca_shapley_fullmodel.png",device = "png")
```
# F XGBoost dependcy plotslatent space

```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))
load("../data/06_230504_dimred_covar_set_vanilla")



#dim_features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","yearmon")
dim_features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","yearmon")
features1<-c("new_cases_smoothed_per_million","diffTemp","stringency_index","weekly_icu_admissions","new_people_vaccinated_smoothed_per_hundred","weekly_hosp_admissions_per_million","diffTemp")

Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))


dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% 
  merge(Xgboostinput, . ,by = "Country Code")-> Xgboostinput_covar_1b

Dimred_covar_set_vanilla %>%  select(`Country Code`,comorb_m_unscaled) %>% rename("Cormodity Index"="comorb_m_unscaled") %>% 
  merge( . ,Xgboostinput_covar_1b,by="Country Code")->Xgboostinput_covar_1c


Xgboostinput_covar2<-Xgboostinput_covar_1c%>%select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Cormodity Index","Regions"))) %>%  drop_na() %>% 
  rename("New cases"=new_cases_smoothed_per_million,"Vaccinations"=new_people_vaccinated_smoothed_per_hundred,"ICU/Week"=weekly_icu_admissions,"Hosp/Week"=weekly_hosp_admissions_per_million,"Excess Mortality"=p_value_mort,"Month in pandemic"=yearmon,"sd(Temp)"=diffTemp)

Xgboostinput_Input_dep_iso<-Xgboostinput_covar2 %>%  select(-life_expectancy) 
```

```{r}
Xgboostinput<- fread("../results/06_Dimred_Exmort__withpc_monthly.csv")
Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))
load("../data/06_230504_dimred_covar_set_vanilla")



dim_features<-c("PC1","PC2","PC3","PC4","PC5","PC6","PC7","PC8","PC9","PC10","PC11","PC12","PC13","PC14","yearmon")
#dim_features<-c("iso1","iso2","iso3","iso4","iso5","iso6","iso7","yearmon")
features1<-c("new_cases_smoothed_per_million","diffTemp","stringency_index","weekly_icu_admissions","new_people_vaccinated_smoothed_per_hundred","weekly_hosp_admissions_per_million","diffTemp")

Xgboostinput<-Xgboostinput %>% mutate(yearmon=as.numeric(as.factor(str_remove(pattern = "[a-zA-Z_]+",identifier))),continent2=as.numeric(as.factor(continent)))


dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% 
  merge(Xgboostinput, . ,by = "Country Code")-> Xgboostinput_covar_1b

Dimred_covar_set_vanilla %>%  select(`Country Code`,comorb_m_unscaled) %>% rename("Cormodity Index"="comorb_m_unscaled") %>% 
  merge( . ,Xgboostinput_covar_1b,by="Country Code")->Xgboostinput_covar_1c


Xgboostinput_covar2<-Xgboostinput_covar_1c%>%select(any_of(c(feature_vector,dim_features,features1,"p_value_mort","Cormodity Index","Regions","Country Code"))) %>%  drop_na() %>% 
  rename("New cases"=new_cases_smoothed_per_million,"Vaccinations"=new_people_vaccinated_smoothed_per_hundred,"ICU/Week"=weekly_icu_admissions,"Hosp/Week"=weekly_hosp_admissions_per_million,"Excess Mortality"=p_value_mort,"Month in pandemic"=yearmon,"sd(Temp)"=diffTemp)

Xgboostinput_Input_dep_pca<-Xgboostinput_covar2 %>%  select(-life_expectancy) 
```


```{r}
suppressPackageStartupMessages({
library("SHAPforxgboost"); library("ggplot2"); library("xgboost")
library("data.table"); library("here")
})

Label<-"Excess Mortality"
 features<-Xgboostinput_Input_dep %>% select(-Label)%>% colnames()
y_var <-  Label
dataX <- as.matrix(Xgboostinput_Input_dep %>% select(features))
# hyperparameter tuning results
param_list <- list(objective = "reg:squarederror",  # For regression
                   eta = 0.3,
                   max_depth = c(3,6),
                   gamma = 0.01,
                   subsample = 0.95
                   )

mod <- xgboost::xgboost(data = dataX, 
                        label = as.matrix(Xgboostinput_Input_dep[[y_var]]), 
                        params = param_list, nrounds = 10,
                        verbose = FALSE, nthread = parallel::detectCores() - 2,
                        early_stopping_rounds = 8)
                       

# To return the SHAP values and ranked features by mean|SHAP|
shap_values <- shap.values(xgb_model = mod, X_train = dataX)
shap_values$mean_shap_score %>%  sum()
# The ranked features by mean |SHAP|
shap_values$mean_shap_score %>% data.frame(freq= . ) %>%  arrange(desc(freq))
```
```{r}
# To prepare the long-format data:
shap_long <- shap.prep(xgb_model = mod, X_train = dataX)
# is the same as: using given shap_contrib
shap_long <- shap.prep(shap_contrib = shap_values$shap_score, X_train = dataX)

# **SHAP summary plot**
shap.plot.summary(shap_long)
```
```{r}
# option 1: from the xgboost model
shap.plot.summary.wrap1(model = mod, X = dataX)

# option 2: supply a self-made SHAP values dataset (e.g. sometimes as output from cross-validation)
shap.plot.summary.wrap2(shap_score = shap_values$shap_score, X = dataX)
```
```{r}
g1 <- shap.plot.dependence(data_long = shap_long, x = 'Month in pandemic', y = 'Month in pandemic', color_feature = 'Column_WV') + ggtitle("(A) SHAP values of Time trend vs. Time trend")
g2 <- shap.plot.dependence(data_long = shap_long, x = 'Month in pandemic', y = 'stringency_index', color_feature = 'Column_WV') +  ggtitle("(B) SHAP values of CWV vs. Time trend")
g3 <- shap.plot.dependence(data_long = shap_long, x = 'Regions', y = 'iso1', color_feature = 'Column_WV') +  ggtitle("(B) SHAP values of CWV vs. Time trend")
gridExtra::grid.arrange(g1, g2,g3, ncol = 3)
shap.plot.dependence(data_long = shap_long, x = 'Regions', y = 'iso4', color_feature = 'Column_WV') +  ggtitle("(B) SHAP values of CWV vs. Time trend")

```
```{r}

dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% select(Regions,RegionSoviet) %>%  unique %>% arrange(Regions)
```
## Forceplots

### PC
```{r}
Xgboostinput_Input_dep<-Xgboostinput_Input_dep_pca

suppressPackageStartupMessages({
library("SHAPforxgboost"); library("ggplot2"); library("xgboost")
library("data.table"); library("here")
})

Label<-"Excess Mortality"
 features<-c("iso1","iso2","iso3","iso4","New cases")
 features<-c("PC1","PC2","PC10","PC5","PC7","New cases")
 y_var <-  Label
dataX <- as.matrix(Xgboostinput_Input_dep %>% select(features))
# hyperparameter tuning results
param_list <- list(objective = "reg:squarederror",  # For regression
                   eta = 0.3,
                   max_depth = c(3,6),
                   gamma = 0.01,
                   subsample = 0.95
                   )

mod <- xgboost::xgboost(data = dataX, 
                        label = as.matrix(Xgboostinput_Input_dep[[y_var]]), 
                        params = param_list, nrounds = 100,
                        verbose = FALSE, nthread = parallel::detectCores() - 2,
                        early_stopping_rounds = 8)
                       

# To return the SHAP values and ranked features by mean|SHAP|
shap_values <- shap.values(xgb_model = mod, X_train = dataX)
shap_values$mean_shap_score %>%  sum()
# The ranked features by mean |SHAP|
# shap_values$mean_shap_score %>% data.frame(freq= . ) %>%  arrange(desc(freq))
# ?
shap_values2<-cbind(shap_values$shap_score,Xgboostinput_Input_dep$regions)
plot_data <- shap.prep.stack.data(shap_contrib = shap_values2, top_n = 6, n_groups = 1)

plot_iso<-cbind(plot_data %>% arrange(ID),a=Xgboostinput_Input_dep_pca$`Country Code`,b=Xgboostinput_Input_dep_pca$`Month in pandemic`,c=Xgboostinput_Input_dep_pca$Regions,d=Xgboostinput_Input_dep_pca$PC1)
#plot_iso2<-plot_iso %>%  arrange(d) %>%  mutate(sorted_id=1:n()) 
plot_iso2<-plot_iso %>%  arrange(desc(c),a,b) %>%  mutate(sorted_id=1:n()) 
plot_iso3<- plot_iso2 %>%  select(-a,-b,-c,-d)
# you may choose to zoom in at a location, and set y-axis limit using `y_parent_limit`
shap.plot.force_plot(plot_iso3, zoom_in_location = countryvalue, y_parent_limit = c(-20,50))
#shap.plot.force_plot_bygroup(plot_data)

# you may choose to zoom in at a location, and set y-axis limit using `y_parent_limit`
isoPLot<-shap.plot.force_plot(plot_iso3, zoom_in_location = 1, y_parent_limit = c(-20,50))+ ggtitle("Orderedbyregion") +theme(legend.position = "bottom")
isoPLot

#ashap
#shap.plot.force_plot_bygroup(plot_data)
#ggsave(ashap,file="../figures/08_Shap_force_plot_pca.png",width = 7,height = 5)
```


### iso
```{r}
Xgboostinput_Input_dep<-Xgboostinput_Input_dep_iso
suppressPackageStartupMessages({
library("SHAPforxgboost"); library("ggplot2"); library("xgboost")
library("data.table"); library("here")
})

Label<-"Excess Mortality"
 features<-c("iso1","iso2","iso3","iso4","New cases")
# features<-c("PC1","PC2","PC3","PC4","PC10","New cases")
 y_var <-  Label
dataX <- as.matrix(Xgboostinput_Input_dep %>% select(features))

# hyperparameter tuning results
param_list <- list(objective = "reg:squarederror",  # For regression
                   eta = 0.3,
                   max_depth = c(3,6),
                   gamma = 0.01,
                   subsample = 0.95
                   )

mod <- xgboost::xgboost(data = dataX, 
                        label = as.matrix(Xgboostinput_Input_dep[[y_var]]), 
                        params = param_list, nrounds = 100,
                        verbose = FALSE, nthread = parallel::detectCores() - 2,
                        early_stopping_rounds = 8)
                       

# To return the SHAP values and ranked features by mean|SHAP|
shap_values <- shap.values(xgb_model = mod, X_train = dataX)
?shap.values

shap_values$mean_shap_score %>%  sum()
# The ranked features by mean |SHAP|
# shap_values$mean_shap_score %>% data.frame(freq= . ) %>%  arrange(desc(freq))
# ?
shap_values2<-shap_values$shap_score


plot_data <- shap.prep.stack.data(shap_contrib = shap_values2, top_n = 7, n_groups = 1)

plot_iso<-cbind(plot_data %>% arrange(ID),a=Xgboostinput_Input_dep_pca$`Country Code`,b=Xgboostinput_Input_dep_pca$`Month in pandemic`,c=Xgboostinput_Input_dep_pca$Regions,d=Xgboostinput_Input_dep_pca$PC1)

plot_iso2<-plot_iso %>%  arrange(desc(c),a,b) %>%  mutate(sorted_id=1:n()) 

#plot_iso2<-plot_iso %>%  arrange(d) %>%  mutate(sorted_id=1:n()) 

plot_iso3<- plot_iso2 %>%  select(-a,-b,-c,-d)
# you may choose to zoom in at a location, and set y-axis limit using `y_parent_limit`
shap.plot.force_plot(plot_iso3, zoom_in_location = countryvalue, y_parent_limit = c(-20,50))
#shap.plot.force_plot_bygroup(plot_data)

# you may choose to zoom in at a location, and set y-axis limit using `y_parent_limit`
isoPLot<-shap.plot.force_plot(plot_iso3, zoom_in_location = 1, y_parent_limit = c(-20,50))+ ggtitle("ISO ordered by region") +theme(legend.position = "bottom")
isoPLot
#shap.plot.force_plot_bygroup(plot_data)
#ggsave(isoPLot,file="../figures/08_Shap_force_plot_iso.png",device = "png",width = 7,height = 5)
```
```{r}
dimred2021_knn250_2 %>% select(`Country Code`,RegionSoviet) %>% unique() %>% mutate(Regions=as.numeric(as.factor(RegionSoviet))) %>% select(Regions,RegionSoviet) %>%  unique %>% arrange(Regions)
```



```{r}
plot_iso %>%  filter(sorted_id>1350,sorted_id<1450)-> subsetISO4

 dimred2021_knn250_5 %>%  filter(`Country Code` %in% (subsetISO4$a %>%  unique)) %>% filter(year%in% 2020) %>%  select(1:4,RegionSoviet) %>%  unique
```



# G Trjaectorie map for Dimred
```{r}
dimred2021_knn250_5 %>% filter(year%in% 2010:2021)%>%  select(`Country Code`,year,RegionSoviet,iso4,`Income Group`,`SI.POV.GINI`) %>% filter(iso4< -0.5) %>%  unique-> ava
ava %>% filter(year%in%2020) %>% select(RegionSoviet)  %>%  table
ava%>% filter(year%in%2020) %>% select(`Income Group`)   %>%  table
ava  %>% select(SI.POV.GINI)%>% drop_na() %>%  summary()
```


```{r}
dimred2021_knn250_5 %>% filter(year%in% 2010:2021)%>%  select(`Country Code`,year,RegionSoviet,iso1,`Income Group`,`SI.POV.GINI`) %>% filter(iso1< 0) %>%  unique -> ava
ava %>% filter(year%in%2020) %>% select(RegionSoviet)  %>%  table
ava%>% filter(year%in%2020) %>% select(`Income Group`)   %>%  table
ava  %>% select(SI.POV.GINI)%>% drop_na() %>%  summary()
```

```{r}
dimred2021_knn250_5 %>% filter(year%in% 2010:2021)%>%  select(`Country Code`,year,RegionSoviet,iso2,`Income Group`,`SI.POV.GINI`) %>% filter(iso2< -0.5) %>%  unique -> ava
ava %>% filter(year%in%2020) %>% select(RegionSoviet)  %>%  table
ava%>% filter(year%in%2020) %>% select(`Income Group`)   %>%  table
ava  %>% select(SI.POV.GINI)%>% drop_na() %>%  summary()

dimred2021_knn250_5 %>% filter(year%in% 2021) %>% ggplot(aes(x=iso4,iso1,color=RegionSoviet)) +geom_point()

```
```{r}
dimred2021_knn250_5 %>% filter(year%in% 2010:2021)%>%  select(`Country Code`,year,RegionSoviet,iso3,`Income Group`,`SI.POV.GINI`) %>% filter(iso3 < -0.2) %>%  unique -> ava
ava %>% filter(year%in%2020) %>% select(RegionSoviet)  %>%  table
ava%>% filter(year%in%2020) %>% select(`Income Group`)   %>%  table
ava  %>% select(SI.POV.GINI)%>% drop_na() %>%  summary()
```

